<meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SC Event Season 3 Project Next</title>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
}

body{
    width:100vw;
    height:100vh;
    overflow:hidden;
    font-family: Arial, sans-serif;
}

.game-container{
    width:100%;
    height:100%;
    position:relative;
}

/* Full background */
.background{
    width:100%;
    height:100%;
    background:url("https://i.ibb.co/whfJpH1q/In-Shot-20251201-103839768.jpg") center no-repeat;
    background-size:cover;
    position:relative;
}

/* Common resource style */
.resource{
    display:flex;
    align-items:center;
    gap:6px;
}

.resource img{
    width:32px;
    height:32px;
    object-fit:contain;
}

.resource span{
    color:#fff;
    font-size:18px;
    font-weight:600;
}

/* ===== Token + Coin Box ===== */
.resource-box-top{
    position:absolute;
    top:8px;
    left:12px;
    background:rgba(0,0,0,0.6);
    border-radius:16px;
    padding:8px 12px;
    backdrop-filter:blur(7px);
    display:flex;
    gap:14px;
}

/* ===== Crystal Box (separate background) ===== */
.resource-box-crystal{
    position:absolute;
    top:58px;          /* Token/Coin ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫ */
    left:12px;
    background:rgba(20, 40, 80, 0.7); /* Crystal ·Äû·ÄÆ·Ä∏·Äû·Äî·Ä∑·Ä∫·Ä°·ÄÅ·Ä∂ */
    border-radius:14px;
    padding:8px 12px;
    backdrop-filter:blur(7px);
}

/* ===== Sidebar Menu Styles ===== */
.sidebar-menu {
    position: fixed;
    top: 50%;
    right: 0;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    z-index: 100;
    transition: all 0.4s ease;
}

/* Sidebar Toggle (open button) */
.sidebar-toggle {
    width: 28px;
    height: 80px;
    background: rgba(20, 20, 20, 0.8);
    border: 1px solid rgba(0, 0, 0, 0.6);
    border-radius: 14px 0 0 14px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 0 5px;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    transition: all 0.3s ease;
    box-shadow: -3px 3px 10px rgba(0, 0, 0, 0.6);
}

.sidebar-toggle:hover {
    background: rgba(35, 35, 35, 0.9);
    border-color: rgba(0, 0, 0, 0.8);
    width: 30px;
}

.sidebar-toggle span {
    width: 16px;
    height: 2px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 1px;
    transition: all 0.3s ease;
}

.sidebar-toggle.active {
    background: rgba(50, 50, 50, 0.9);
    border-color: rgba(0, 0, 0, 0.8);
}

.sidebar-toggle.active span:nth-child(1) {
    transform: rotate(45deg) translate(4px, 4px);
}
.sidebar-toggle.active span:nth-child(2) {
    opacity: 0;
}
.sidebar-toggle.active span:nth-child(3) {
    transform: rotate(-45deg) translate(4px, -4px);
}

/* Sidebar Buttons Container */
.sidebar-buttons {
    display: none;
    flex-direction: column;
    gap: 10px;
    background: linear-gradient(135deg, rgba(5,5,5,0.95), rgba(15,15,15,0.85));
    padding: 18px;
    border-radius: 18px 0 0 18px;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(0, 0, 0, 0.6);
    margin-right: -8px;
    animation: slideIn 0.35s ease;
    box-shadow: -5px 5px 25px rgba(0,0,0,0.7);
}

.sidebar-buttons.show {
    display: flex;
}

/* Slide animation */
@keyframes slideIn {
    from { 
        opacity: 0;
        transform: translateX(25px);
    }
    to { 
        opacity: 1;
        transform: translateX(0);
    }
}

/* Sidebar Button */
.sidebar-btn {
    padding: 14px 22px;
    font-size: 15px;
    border: none;
    border-radius: 10px;
    background: linear-gradient(145deg, rgba(0,90,255,0.85), rgba(0,60,180,0.8));
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
    min-width: 150px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(0, 100, 255, 0.4);
    box-shadow: 0 0 10px rgba(0, 100, 255, 0.3);
}

.sidebar-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition: left 0.5s ease;
}

.sidebar-btn:hover::before {
    left: 100%;
}

.sidebar-btn:hover {
    background: linear-gradient(145deg, rgba(0,100,255,0.95), rgba(0,70,200,0.9));
    transform: translateX(-5px);
    box-shadow: -2px 2px 20px rgba(0,120,255,0.5);
}

.sidebar-btn:active {
    background: rgba(0,80,200,0.9);
    transform: translateX(-3px);
}

.sidebar-btn:disabled {
    background: rgba(0,0,0,0.2);
    color: rgba(255,255,255,0.6);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    border-color: rgba(255,255,255,0.1);
}

.sidebar-btn:disabled:hover::before {
    left: -100%;
}

/* Mobile adjust */
@media (max-width:600px){
    .resource img{
        width:28px;
        height:28px;
    }
    .resource span{
        font-size:16px;
    }
    
    /* Sidebar Responsive */
    .sidebar-btn {
        min-width: 125px;
        padding: 11px 16px;
        font-size: 13px;
    }

    .sidebar-buttons {
        padding: 14px;
    }

    .sidebar-toggle {
        height: 65px;
        width: 25px;
    }
}

/* Loading Screen */
.loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
}

/* Full Screen Loading Image */
.loading-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Bigger Circle at Bottom */
.loading-circle {
    position: absolute;
    bottom: 30px;
    left: 45%;
    transform: translateX(-50%);
    width: 60px;
    height: 60px;
    border: 6px solid rgba(255, 255, 255, 0.3);
    border-top: 6px solid #2196F3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translateX(-50%) rotate(0deg); }
    100% { transform: translateX(-50%) rotate(360deg); }
}

/* Bigger Enter Button (Initially hidden) */
.enter-btn {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    padding: 14px 35px; /* Bigger padding */
    font-size: 18px;    /* Bigger font */
    font-weight: bold;
    background: linear-gradient(145deg, #2196F3, #0D47A1);
    color: white;
    border: none;
    border-radius: 30px; /* Bigger radius */
    cursor: pointer;
    display: none;
    box-shadow: 0 5px 20px rgba(33, 150, 243, 0.5);
    white-space: nowrap;
    min-width: 150px; /* Minimum width */
}

.enter-btn.show {
    display: block;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: translateX(-50%) scale(1); }
    50% { transform: translateX(-50%) scale(1.05); }
    100% { transform: translateX(-50%) scale(1); }
}

.enter-btn:hover {
    background: linear-gradient(145deg, #1E88E5, #0D47A1);
    transform: translateX(-50%) scale(1.07);
}

/* Mobile adjustments */
@media (max-width: 600px) {
    .loading-circle {
        width: 50px;
        height: 50px;
        border-width: 3px;
    }
    
    .enter-btn {
        padding: 12px 28px;
        font-size: 16px;
        min-width: 130px;
    }
}

/* ===== Account Creation Screen ===== */
.account-creation-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    background: rgba(0, 0, 0, 0.8);
}

.account-background {
    position: absolute;
    width: 100%;
    height: 100%;
    background: url("https://i.ibb.co/xSDTQG3X/b9732bc537596383fb4b4a5999973995.jpg") center/cover no-repeat;
    filter: brightness(0.3) saturate(1.3);
    opacity: 0.9;
}

/* Glass Container */
.glass-container {
    position: relative;
    width: 320px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 35px 25px;
    text-align: center;
    box-shadow: 
        0 15px 35px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 0 40px rgba(255, 255, 255, 0.05);
    animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Profile Circle */
.profile-circle-wrapper {
    margin-bottom: 30px;
}

.profile-circle-glow {
    position: absolute;
    width: 130px;
    height: 130px;
    background: radial-gradient(circle, rgba(0, 150, 255, 0.2), transparent 70%);
    border-radius: 50%;
    margin: -10px auto;
    animation: glowPulse 2s infinite alternate;
}

@keyframes glowPulse {
    from { opacity: 0.2; transform: scale(0.95); }
    to { opacity: 0.4; transform: scale(1.05); }
}

.profile-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(0, 150, 255, 0.2), rgba(0, 100, 200, 0.1));
    border: 2px solid rgba(255, 255, 255, 0.25);
    margin: 0 auto;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 
        0 8px 25px rgba(0, 150, 255, 0.2),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
}

.profile-circle:hover {
    transform: scale(1.1);
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 
        0 12px 30px rgba(0, 150, 255, 0.3),
        inset 0 0 30px rgba(255, 255, 255, 0.15);
}

.emoji-display {
    font-size: 40px;
    line-height: 1;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s;
}

.profile-circle:hover .emoji-display {
    transform: scale(1.2);
}

.upload-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
    border-radius: 50%;
}

.profile-circle:hover .upload-overlay {
    opacity: 1;
}

.upload-icon {
    width: 24px;
    height: 24px;
    fill: white;
}

.profile-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 13px;
    margin-top: 8px;
    font-weight: 500;
}

/* Name Input */
.name-input-wrapper {
    margin-bottom: 25px;
    position: relative;
}

.name-input {
    width: 100%;
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.07);
    border: 1.5px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    color: white;
    font-size: 15px;
    text-align: center;
    outline: none;
    transition: all 0.3s;
    font-family: inherit;
    letter-spacing: 0.5px;
}

.name-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
    font-weight: normal;
}

.name-input:focus {
    background: rgba(255, 255, 255, 0.1);
    border-color: #4dabf7;
    box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.15);
}

.input-line {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, #4dabf7, transparent);
    transition: width 0.4s ease;
}

.name-input:focus + .input-line {
    width: 60%;
}

/* Buttons */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
}

.action-btn {
    padding: 14px 20px;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
    letter-spacing: 0.3px;
}

.upload-btn {
    background: rgba(255, 255, 255, 0.09);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.upload-btn:hover {
    background: rgba(255, 255, 255, 0.13);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

.create-btn {
    background: linear-gradient(135deg, #4dabf7, #339af0);
    color: white;
    border: 1px solid rgba(77, 171, 247, 0.4);
}

.create-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #339af0, #228be6);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(77, 171, 247, 0.25);
}

.create-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.btn-icon {
    width: 18px;
    height: 18px;
    fill: currentColor;
    flex-shrink: 0;
}

/* Loading */
.loading-section {
    margin-top: 15px;
}

.spinner {
    width: 35px;
    height: 35px;
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top: 3px solid #4dabf7;
    border-radius: 50%;
    margin: 0 auto 10px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    color: rgba(255, 255, 255, 0.7);
    font-size: 13px;
    font-weight: 500;
}

/* Error Message */
.error-section {
    background: rgba(255, 107, 107, 0.1);
    color: #ff6b6b;
    padding: 10px 15px;
    border-radius: 8px;
    margin-top: 15px;
    border: 1px solid rgba(255, 107, 107, 0.2);
    font-size: 13px;
    backdrop-filter: blur(10px);
}

/* Mobile Responsive */
@media (max-width: 400px) {
    .glass-container {
        width: 90%;
        padding: 30px 20px;
    }
    
    .profile-circle {
        width: 90px;
        height: 90px;
    }
    
    .emoji-display {
        font-size: 36px;
    }
    
    .name-input {
        padding: 13px 16px;
        font-size: 14px;
    }
    
    .action-btn {
        padding: 13px 18px;
        font-size: 13.5px;
    }
    
    .btn-icon {
        width: 16px;
        height: 16px;
    }
}
</style>
</head>
<body>

<!-- Account Creation Screen -->
<div class="account-creation-screen" id="account-creation-screen" style="display:none;">
    <div class="account-background"></div>
    
    <div class="glass-container">
        <!-- Profile Circle -->
        <div class="profile-circle-wrapper">
            <div class="profile-circle-glow"></div>
            <div class="profile-circle" id="profile-circle">
                <div class="emoji-display">üë§</div>
                <div class="upload-overlay">
                    <svg class="upload-icon" viewBox="0 0 24 24">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                </div>
            </div>
            <div class="profile-label">·Äï·ÄØ·Ä∂·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫</div>
        </div>
        
        <!-- Name Input -->
        <div class="name-input-wrapper">
            <input type="text" id="user-name" class="name-input" placeholder="·Äî·Ä¨·Äô·Ää·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´" maxlength="20" required>
            <div class="input-line"></div>
        </div>
        
        <!-- Buttons -->
        <div class="action-buttons">
            <button class="action-btn upload-btn" id="upload-profile-btn">
                <svg class="btn-icon" viewBox="0 0 24 24">
                    <path d="M4 5h13v7h2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h8v-2H4V5z"/>
                    <path d="M22 12v6c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2v-6c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2zm-2 0H8v6h12v-6zm-7 4l4-4h-3V8h-2v4H9l4 4z"/>
                </svg>
                <span>·Äï·ÄØ·Ä∂·Äê·ÄÑ·Ä∫·Äô·Ää·Ä∫</span>
            </button>
            
            <button class="action-btn create-btn" id="create-account-btn">
                <svg class="btn-icon" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <span>·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äô·Ää·Ä∫</span>
            </button>
        </div>
        
        <!-- Loading -->
        <div class="loading-section" id="account-loading" style="display:none;">
            <div class="spinner"></div>
            <div class="loading-text">·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫...</div>
        </div>
        
        <!-- Error Message -->
        <div class="error-section" id="error-message" style="display:none;"></div>
    </div>
    
    <input type="file" id="profile-file-input" accept="image/*" style="display:none;">
</div>


<!-- Loading Screen -->
<div class="loading-screen" id="loading-screen">
    <img class="loading-image" id="loading-image" src="" alt="Loading Image">
    <div class="loading-circle" id="loading-circle"></div>
    <button class="enter-btn" id="enter-btn">
        ·ÅÄ·ÄÑ·Ä∫·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Ää·Ä∫
    </button>
</div>

<div class="game-container" id="game-container" style="display:none;">

<div class="game-container">
    <div class="background">

        <!-- Token & Coin -->
        <div class="resource-box-top">
            <div class="resource">
                <img src="https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png">
                <span id="token-count">0</span>
            </div>

            <div class="resource">
                <img src="https://i.ibb.co/JWHLf84k/Grid-Art-20251225-163557125.png">
                <span id="coin-count">0</span>
            </div>
        </div>

        <!-- Crystal (separate background) -->
        <div class="resource-box-crystal">
            <div class="resource">
                <img src="https://i.ibb.co/qMrrdSPm/Grid-Art-20251018-170713563.png">
                <span id="crystal-count">0</span>
            </div>
        </div>

        <!-- Sidebar Menu -->
        <div class="sidebar-menu">
            <button class="sidebar-toggle" id="sidebar-toggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="sidebar-buttons" id="sidebar-buttons">
                <button class="sidebar-btn" id="event-btn">
                    <span>Coins Box</span>
                </button>
                <button class="sidebar-btn" id="task-btn">
                    <span>Task ·Äô·Äª·Ä¨·Ä∏</span>
                </button>
                <button class="sidebar-btn" id="exchange-btn">
                    <span>·Äú·Ä≤·Äô·Ää·Ä∫</span>
                </button>
                <button class="sidebar-btn" id="battle-btn">
                    <span>Token Box</span>
                </button>
       
        
         
            </div>
        </div>

    </div>
</div>

<audio id="bg-music" loop>
    <source src="„Éñ„É´„Éº„Ç¢„Éº„Ç´„Ç§„Éñ_Blue_Archive_OST_139._Cherry_Merry_Berry(720p).mp3" type="audio/mpeg">
</audio>


<script>
// Sidebar Toggle Functionality
const menuToggle = document.getElementById('sidebar-toggle');
const menuButtons = document.getElementById('sidebar-buttons');
const menuContainer = document.querySelector('.sidebar-menu');

menuToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    menuButtons.classList.toggle('show');
    
    // Toggle active class for animation
    if (menuButtons.classList.contains('show')) {
        menuToggle.classList.add('active');
    } else {
        menuToggle.classList.remove('active');
    }
});

// Close menu when clicking outside
document.addEventListener('click', (e) => {
    if (!menuContainer.contains(e.target) && menuButtons.classList.contains('show')) {
        menuButtons.classList.remove('show');
        menuToggle.classList.remove('active');
    }
});

// Prevent menu from closing when clicking inside menu buttons
menuButtons.addEventListener('click', (e) => {
    e.stopPropagation();
});

// Random Loading Images Array
const loadingImages = [
    "https://i.ibb.co/zTz4HWKV/Grid-Art-20251201-174500600.jpg",
    "https://i.ibb.co/tS8x1NN/Grid-Art-20251201-174440283.jpg",
    "https://i.ibb.co/5WHvk572/Grid-Art-20251201-174349581.jpg",
    "https://i.ibb.co/x8FNdDqn/Grid-Art-20251201-173834315.jpg",
    "https://i.ibb.co/fzYkY1Zg/Grid-Art-20251201-173744578.jpg",
    "https://i.ibb.co/fV9d8pvc/Grid-Art-20251201-173622305.jpg",
    "https://i.ibb.co/NdFnnmWM/Grid-Art-20251201-173705204.jpg",
    "https://i.ibb.co/5gW6qxFM/Grid-Art-20251201-173540051.jpg"
];

// Loading Screen Functionality
document.addEventListener('DOMContentLoaded', function() {
    const loadingScreen = document.getElementById('loading-screen');
    const gameContainer = document.getElementById('game-container');
    const loadingImage = document.getElementById('loading-image');
    const loadingCircle = document.getElementById('loading-circle');
    const enterBtn = document.getElementById('enter-btn');
    
    // Select random loading image
    const randomIndex = Math.floor(Math.random() * loadingImages.length);
    loadingImage.src = loadingImages[randomIndex];
    
    // Wait for 3 seconds then show enter button
    setTimeout(() => {
        // Hide loading circle
        loadingCircle.style.display = 'none';
        
        // Show enter button
        enterBtn.classList.add('show');
    }, 3000);
    
    // Enter button click handler
    enterBtn.addEventListener('click', function() {
        // Hide loading screen immediately
        loadingScreen.style.display = 'none';
        gameContainer.style.display = 'block';
        
        // Initialize user resources from local storage
        initializeUserResources();
    });
});

// User resources ·ÄÖ·Äê·ÄÑ·Ä∫·Äû·Äê·Ä∫·Äô·Äæ·Äê·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ function
function initializeUserResources() {
    // Local storage ·Äô·Äæ·Ä¨ user data ·Äõ·Äæ·Ä≠·Äô·Äõ·Äæ·Ä≠·ÄÖ·ÄÖ·Ä∫·Äï·Ä´
    let userData = localStorage.getItem('gameUserData');
    
    if (!userData) {
        // ·Äï·Äë·Äô·ÄÜ·ÄØ·Ä∂·Ä∏·Ä°·ÄÄ·Äº·Ä≠·Äô·Ä∫ ·ÅÄ·ÄÑ·Ä∫·Äê·Ä≤·Ä∑ user ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ default values ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´
        const defaultData = {
            tokens: 0,  // Token 10 ·Äï·Ä±·Ä∏·Äô·Äö·Ä∫
            coins: 0,
            crystals: 0
        };
        localStorage.setItem('gameUserData', JSON.stringify(defaultData));
        userData = JSON.stringify(defaultData);
    }
    
    // Local storage ·ÄÄ·Äî·Ä± data ·ÄÄ·Ä≠·ÄØ·Äñ·Äê·Ä∫·Äï·Äº·ÄÆ·Ä∏ UI ·Äô·Äæ·Ä¨·Äï·Äº·Äï·Ä´
    const data = JSON.parse(userData);
    document.getElementById('token-count').textContent = data.tokens;
    document.getElementById('coin-count').textContent = data.coins;
    document.getElementById('crystal-count').textContent = data.crystals;
}

// ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äë·Äï·Ä∫ function ·Äô·Äª·Ä¨·Ä∏ - resources update ·Äú·ÄØ·Äï·Ä∫·Äõ·Äî·Ä∫·Ä°·Äê·ÄΩ·ÄÄ·Ä∫
function updateTokenCount(newCount) {
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"tokens":0,"coins":0,"crystals":0}');
    userData.tokens = newCount;
    localStorage.setItem('gameUserData', JSON.stringify(userData));
    document.getElementById('token-count').textContent = newCount;
}

function updateCoinCount(newCount) {
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"tokens":0,"coins":0,"crystals":0}');
    userData.coins = newCount;
    localStorage.setItem('gameUserData', JSON.stringify(userData));
    document.getElementById('coin-count').textContent = newCount;
}

function updateCrystalCount(newCount) {
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"tokens":0,"coins":0,"crystals":0}');
    userData.crystals = newCount;
    localStorage.setItem('gameUserData', JSON.stringify(userData));
    document.getElementById('crystal-count').textContent = newCount;
}




// ===== HOME SCREEN CHAT SYSTEM =====
const chatTexts = [
    "·Äû·Ä≠·Äë·Ä¨·Ä∏·ÄÖ·Äõ·Ä¨‚Äå·Äê·ÄΩ·Ä±·Äï·Äº·Ä±·Ä¨·Äï·Äº·Äï·Ä´·Äô·Äö·Ä∫ ü©µ",
    "Token ·Äô·Äª·Ä¨·Ä∏·Äõ·Äõ·Äæ·Ä≠·Äõ·Äî·Ä∫ Tasks ·Äô·Äª·Ä¨·Ä∏·Äú·ÄØ·Äï·Ä∫·Äï·Ä´",
    "Token ·Äñ·Äº·ÄÑ·Ä∑·Ä∫ Coins Box ·Äë·Ä≤·Äô·Äæ·Ä¨ Coins ·Äõ·Äö·Ä∞·Äï·Ä´",
    "Token ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ Token Box ·ÄÄ·Äî·Ä±·Äú·Ä≤·Äö·Ä∞·Äî·Ä≠·ÄØ·ÄÑ·Ä∫",
    "Coins ·Äî·Ä≤·Ä∑ Diamonds ·Äú·Ä≤·Äú·Ä≠·ÄØ·Ä∑·Äõ·Äï·Ä´·Äê·Äö·Ä∫",
    "·Äú·Ä≤·Äê·Ä≤·Ä∑·Ä°·ÄÅ·Ä´ ·Äú·Ä≤·Äõ·Äû·Ä±·Ä∏·Äú·Ä¨·Ä∏·ÄÜ·Ä≠·ÄØ·Äê·Ä¨·Äû·Ä±·ÄÅ·Äª·Ä¨·ÄÖ·ÄÖ·Ä∫·Äï·Ä´",
    "·Äî·ÄÑ·Ä∫·Äô·Äú·Ä¨·Ä∏·ÄÅ·Äª·ÄÖ·Ä∫·Äû·Ä∞·Äô·Äõ·Äæ·Ä≠·Äê·Ä¨ üòπ",
    "·Äï·Äº·Äî·Ä∫·Äô·Äú·Ä¨·Äê·Ä≤·Ä∑·Äû·Ä∞·ÄÄ·Ä≠·ÄØ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äô·Äî·Ä±·Äï·Ä´·Äî·Ä≤·Ä∑·Äú·Ä¨·Ä∏ üíî"
];

// Container
const chatContainer = document.createElement('div');
chatContainer.style.cssText = `
    position: fixed;
    bottom: 28px;
    width: 100%;
    display: flex;
    justify-content: center;
    pointer-events: none;
    z-index: 10;
`;

// Bubble (·Ä°·Äô·Äº·Ä≤·Äï·Ä±·Ä´)
const chatBubble = document.createElement('div');
chatBubble.style.cssText = `
    background: rgba(0, 0, 0, 0.45);   /* ·Ä°·Äô·Ä≤ ·Ä°·Äî·ÄØ ·Ä°·Äñ·Äª·Ä±·Ä¨·Ä∑ */
    color: #ffffff;
    padding: 12px 18px;
    border-radius: 18px;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    max-width: 90%;
    min-height: 44px;                 /* Bubble ·Äô·ÄÅ·Äª·ÄØ·Ä∂·Ä∑ */
    line-height: 1.5;
    box-shadow: 0 8px 30px rgba(0,0,0,0.35);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border: 1px solid rgba(255,255,255,0.18);
`;

chatContainer.appendChild(chatBubble);
document.body.appendChild(chatContainer);

// Typing logic (·ÄÖ·Ä¨·Äï·Ä≤·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏)
let chatIndex = 0;
let charIndex = 0;

function typeText() {
    const text = chatTexts[chatIndex];

    if (charIndex < text.length) {
        chatBubble.textContent += text.charAt(charIndex);
        charIndex++;
        setTimeout(typeText, 55);
    } else {
        setTimeout(nextText, 3500);
    }
}

function nextText() {
    chatBubble.textContent = "";   // ‚ùó ·Ä°·ÄÅ·Ä∂·Äô·Äë·Ä≠·Åä ·ÄÖ·Ä¨·Äï·Ä≤·Äõ·Äæ·ÄÑ·Ä∫·Ä∏
    charIndex = 0;
    chatIndex = (chatIndex + 1) % chatTexts.length;
    setTimeout(typeText, 300);
}

// Start typing only (bubble already visible)
typeText();


// ===== COINS BOX SYSTEM =====
// Create Coins Box Screen
const coinsBoxHTML = `
<div class="coins-box-screen" id="coins-box-screen" style="display:none;">
    <div class="coins-box-background"></div>
    
    <div class="coins-box-content">
        <!-- Back Button -->
        <button class="coins-back-btn" id="coins-box-back-btn">‚Üê Back</button>
        
        <!-- Effect Container -->
        <div class="coins-effect-container" id="coins-effect-container"></div>
        
        <!-- Result Popup -->
        <div class="coins-result-popup" id="coins-result-popup" style="display:none;">
            <div class="popup-content">
                <div class="popup-title">·Äõ·Äõ·Äæ·Ä≠·Äï·Ä´·Äû·Ää·Ä∫</div>
                <div class="popup-coins-display">
                    <img src="https://i.ibb.co/JWHLf84k/Grid-Art-20251225-163557125.png" class="coins-icon">
                    <div class="coins-amount">+<span id="popup-coins-gained">0</span></div>
                </div>
                <button class="popup-close-btn" id="popup-close-btn">OK</button>
            </div>
        </div>
        
        <!-- Small buttons in one row -->
        <div class="coins-buttons-row">
            <button class="coins-open-btn" id="open-1-btn-small">
                <span class="btn-label">1 Open</span>
                <span class="btn-cost">1 Token</span>
            </button>
            
            <button class="coins-open-btn" id="open-10-btn-small">
                <span class="btn-label">10 Open</span>
                <span class="btn-cost">10 Tokens</span>
            </button>
        </div>
    </div>
</div>
`;

// Insert coins box HTML into body
document.body.insertAdjacentHTML('beforeend', coinsBoxHTML);

// Add CSS for coins box
const coinsBoxCSS = `
<style>
/* Coins Box Screen Styles */
.coins-box-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1000;
    display: none;
}

.coins-box-background {
    position: absolute;
    width: 100%;
    height: 100%;
    background: url("https://i.ibb.co/gZmVvmKM/Grid-Art-20251222-173122396.jpg") center no-repeat;
    background-size: cover;
}

.coins-box-content {
    position: relative;
    width: 100%;
    height: 100%;
}

/* Back Button */
.coins-back-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    background: #3498db;
    color: white;
    border: none;
    padding: 10px 25px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    z-index: 10;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.coins-back-btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
}

/* Effect Container */
.coins-effect-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
    overflow: hidden;
}

/* Particle Effects */
.coin-particle {
    position: absolute;
    width: 25px;
    height: 25px;
    background: url("https://i.ibb.co/JWHLf84k/Grid-Art-20251225-163557125.png") center no-repeat;
    background-size: contain;
    pointer-events: none;
    z-index: 5;
    animation: coinFloat 1.5s ease-out forwards;
}

@keyframes coinFloat {
    0% {
        transform: translate(0, 0) scale(1) rotate(0deg);
        opacity: 1;
    }
    100% {
        transform: translate(var(--tx), var(--ty)) scale(0) rotate(720deg);
        opacity: 0;
    }
}

/* Small Buttons Row */
.coins-buttons-row {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 15px;
    z-index: 10;
}

.coins-open-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    min-width: 110px;
    box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.coins-open-btn:hover:not(:disabled) {
    background: #2980b9;
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(52, 152, 219, 0.6);
}

.coins-open-btn:disabled {
    background: #666;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-label {
    font-size: 16px;
    font-weight: bold;
}

.btn-cost {
    font-size: 12px;
    color: #FFD700;
    margin-top: 3px;
    font-weight: normal;
}

/* Result Popup */
.coins-result-popup {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 20;
}

.popup-content {
    background: rgba(0, 0, 0, 0.9);
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    border: 3px solid #3498db;
    min-width: 300px;
    box-shadow: 0 0 30px rgba(52, 152, 219, 0.5);
}

.popup-title {
    color: #3498db;
    font-size: 24px;
    margin-bottom: 20px;
    font-weight: bold;
}

.popup-coins-display {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin: 25px 0;
}

.coins-icon {
    width: 60px;
    height: 60px;
    filter: drop-shadow(0 0 10px gold);
}

.coins-amount {
    color: #FFD700;
    font-size: 36px;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
}

.popup-close-btn {
    background: #3498db;
    color: white;
    border: none;
    padding: 10px 30px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    margin-top: 20px;
    transition: all 0.3s ease;
}

.popup-close-btn:hover {
    background: #2980b9;
}

/* Mobile responsive */
@media (max-width: 600px) {
    .coins-buttons-row {
        bottom: 30px;
        gap: 10px;
        flex-direction: row;
        width: 90%;
        justify-content: center;
    }
    
    .coins-open-btn {
        min-width: 100px;
        padding: 10px 20px;
    }
    
    .popup-content {
        min-width: 280px;
        padding: 25px;
    }
    
    .popup-title {
        font-size: 22px;
    }
    
    .coins-icon {
        width: 50px;
        height: 50px;
    }
    
    .coins-amount {
        font-size: 32px;
    }
}
</style>
`;

// Insert coins box CSS into head
document.head.insertAdjacentHTML('beforeend', coinsBoxCSS);

// Coins Box Variables
let coinsBoxScreen, coinsBackBtn, open1BtnSmall, open10BtnSmall, coinsResultPopup, popupCloseBtn, popupCoinsGained;

// Coins prizes array
const coinPrizes = [10, 20, 30, 50, 60, 80, 100];

// Initialize coins box
function initializeCoinsBox() {
    // Get elements
    coinsBoxScreen = document.getElementById('coins-box-screen');
    coinsBackBtn = document.getElementById('coins-box-back-btn');
    open1BtnSmall = document.getElementById('open-1-btn-small');
    open10BtnSmall = document.getElementById('open-10-btn-small');
    coinsResultPopup = document.getElementById('coins-result-popup');
    popupCloseBtn = document.getElementById('popup-close-btn');
    popupCoinsGained = document.getElementById('popup-coins-gained');
    
    // Setup event listeners
    setupCoinsBoxEvents();
}

// Setup coins box events
function setupCoinsBoxEvents() {
    // Coins Box button ·ÄÄ·Ä≠·ÄØ·Äî·Äæ·Ä≠·Äï·Ä∫·Äõ·ÄÑ·Ä∫
    document.getElementById('event-btn').addEventListener('click', function() {
        document.getElementById('game-container').style.display = 'none';
        coinsBoxScreen.style.display = 'block';
        coinsResultPopup.style.display = 'none';
    });

    // Back button
    coinsBackBtn.addEventListener('click', function() {
        coinsBoxScreen.style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
    });

    // 1 Open button
    open1BtnSmall.addEventListener('click', function() {
        openCoinsBox(1);
    });

    // 10 Open button
    open10BtnSmall.addEventListener('click', function() {
        openCoinsBox(10);
    });

    // Popup close button
    popupCloseBtn.addEventListener('click', function() {
        coinsResultPopup.style.display = 'none';
    });
}

// Open coins box function
function openCoinsBox(openCount) {
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"tokens":10,"coins":0,"crystals":0}');
    
    // Check if user has enough tokens
    if (userData.tokens < openCount) {
        alert(`Tokens ·Äô·Äú·ÄØ·Ä∂·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä´! ·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠ Tokens: ${userData.tokens}`);
        return;
    }
    
    // Disable buttons during effect
    open1BtnSmall.disabled = true;
    open10BtnSmall.disabled = true;
    
    // Create particle effect
    createParticleEffect();
    
    // Calculate coins after effect
    setTimeout(() => {
        let totalCoinsGained = 0;
        
        // Get random coins
        for (let i = 0; i < openCount; i++) {
            totalCoinsGained += coinPrizes[Math.floor(Math.random() * coinPrizes.length)];
        }
        
        // Update user data
        userData.tokens -= openCount;
        userData.coins += totalCoinsGained;
        
        // Save to local storage
        localStorage.setItem('gameUserData', JSON.stringify(userData));
        
        // Update main UI
        document.getElementById('token-count').textContent = userData.tokens;
        document.getElementById('coin-count').textContent = userData.coins;
        
        // Show result popup after effect
        popupCoinsGained.textContent = totalCoinsGained;
        coinsResultPopup.style.display = 'flex';
        
        // Re-enable buttons
        open1BtnSmall.disabled = false;
        open10BtnSmall.disabled = false;
        
    }, 1500);
}

// Create particle effect
function createParticleEffect() {
    const container = document.getElementById('coins-effect-container');
    container.innerHTML = '';
    
    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight / 2;
    
    // Create coin particles
    const particleCount = 20;
    for (let i = 0; i < particleCount; i++) {
        setTimeout(() => {
            const particle = document.createElement('div');
            particle.className = 'coin-particle';
            
            // Random direction and distance
            const angle = Math.random() * Math.PI * 2;
            const distance = 150 + Math.random() * 200;
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;
            
            particle.style.left = centerX + 'px';
            particle.style.top = centerY + 'px';
            particle.style.setProperty('--tx', endX + 'px');
            particle.style.setProperty('--ty', endY + 'px');
            
            // Random size
            const size = 20 + Math.random() * 15;
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            
            container.appendChild(particle);
            
            // Remove after animation
            setTimeout(() => {
                if (particle.parentNode === container) container.removeChild(particle);
            }, 1500);
        }, i * 50);
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeCoinsBox, 100);
});


// Supabase 4 Servers
const SUPABASE_SERVERS = [
    {
        id: 1,
        url: "https://dbirkhgrwlewfryozphh.supabase.co",
        key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiaXJraGdyd2xld2ZyeW96cGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg0MDAsImV4cCI6MjA4MTYwNDQwMH0.zoOsk1NAzpGgiHRw9ozEpMoi0VP8GxTdZbwsJyEp2Ts",
        maxUsers: 100
    },
    {
        id: 2,
        url: "https://ryvpgilgbslkugpbjjkt.supabase.co",
        key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5dnBnaWxnYnNsa3VncGJqamt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg1MTUsImV4cCI6MjA4MTYwNDUxNX0.vE387j8txP8rOMQRQmGdJlQH4IgVOB7jO09HV5SSRVA",
        maxUsers: 100
    },
    {
        id: 3,
        url: "https://wfwirpmhbkqfsocfoqsq.supabase.co",
        key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indmd2lycG1oYmtxZnNvY2ZvcXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg3NjIsImV4cCI6MjA4MTYwNDc2Yn0.GEb_HB9WXOqtSWOm5Tau6A1fUr8ELX0asrvQOAaPByU",
        maxUsers: 100
    },
    {
        id: 4,
        url: "https://hcfimtxbgqumfiqsbjwz.supabase.co",
        key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjZmltdHhiZ3F1bWZpcXNiand6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg4ODMsImV4cCI6MjA4MTYwNDg4M30.CID5IGMpZhL8D5hczVZ4JOxL2vEz6RiYQzN5bh7jmfY",
        maxUsers: 100
    }
];

// Generate 10-digit User ID
function generateUserID() {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    return timestamp + random;
}

// Get Supabase client
function getSupabaseClient(serverIndex = 0) {
    const server = SUPABASE_SERVERS[serverIndex];
    return supabase.createClient(server.url, server.key);
}

// Convert image to Base64
function convertImageToBase64(file) {
    return new Promise((resolve, reject) => {
        if (!file) {
            resolve(null);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = () => {
            console.log('Image converted successfully:', file.name);
            resolve(reader.result);
        };
        reader.onerror = (error) => {
            console.error('Image conversion error:', error);
            reject(error);
        };
        
        try {
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('File reading error:', error);
            reject(error);
        }
    });
}

// Update resource display
function updateResourceDisplay(tokens, coins, crystals) {
    const tokenElement = document.getElementById('token-count');
    const coinElement = document.getElementById('coin-count');
    const crystalElement = document.getElementById('crystal-count');
    
    if (tokenElement && tokens !== undefined) tokenElement.textContent = tokens;
    if (coinElement && coins !== undefined) coinElement.textContent = coins;
    if (crystalElement && crystals !== undefined) crystalElement.textContent = crystals;
}

// ========== 100 USER LIMIT SYSTEM ==========
// Function to count users in each server
async function countServerUsers(serverIndex) {
    try {
        const supabaseClient = getSupabaseClient(serverIndex);
        const { count, error } = await supabaseClient
            .from('users')
            .select('*', { count: 'exact', head: true });
        
        if (!error) {
            return count || 0;
        }
        return 999; // Mark as full if error
    } catch (error) {
        return 999;
    }
}

// Function to find server with least users and available space
async function findServerWithLeastUsers() {
    console.log("Checking all servers for user count...");
    
    const serverStats = [];
    
    // Count users in all servers
    for (let i = 0; i < SUPABASE_SERVERS.length; i++) {
        const userCount = await countServerUsers(i);
        serverStats.push({
            serverIndex: i,
            userCount: userCount
        });
        console.log(`Server ${i + 1}: ${userCount} users`);
    }
    
    // Sort by user count (ascending) - ·Äú·Ä∞·Ä°·Äî·Ää·Ä∫·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏·ÄÄ·Ä≠·ÄØ·Ä°·Äõ·ÄÑ·Ä∫·Äõ·ÄΩ·Ä±·Ä∏
    serverStats.sort((a, b) => a.userCount - b.userCount);
    
    // Check if the server with least users has space (less than 100)
    for (const stat of serverStats) {
        if (stat.userCount < 100) {
            console.log(`Selected Server ${stat.serverIndex + 1} with ${stat.userCount}/100 users (Least users)`);
            return stat.serverIndex;
        }
    }
    
    // All servers have 100 or more users
    console.log("All servers are full (100+ users each)");
    return null;
}

// Modified createUserAccount function to use server with least users
async function createUserAccount(userName, profileImage) {
    const loading = document.getElementById('account-loading');
    const errorMsg = document.getElementById('error-message');
    const createBtn = document.getElementById('create-account-btn');
    
    try {
        loading.style.display = 'block';
        createBtn.disabled = true;
        errorMsg.style.display = 'none';
        
        if (!userName || userName.trim().length === 0) {
            throw new Error('·Äî·Ä¨·Äô·Ää·Ä∫·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äï·Ä´·Äû·Ää·Ä∫');
        }
        
        // Find server with least users (under 100)
        const selectedServerIndex = await findServerWithLeastUsers();
        
        if (selectedServerIndex === null) {
            throw new Error('·ÄÜ·Ä¨·Äó·Ä¨·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·Äï·Äº·Ää·Ä∑·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫ (·Äê·ÄÖ·Ä∫·ÄÜ·Ä¨·Äó·Ä¨·Äú·Äª·Äæ·ÄÑ·Ä∫ 100 ·Äö·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ·Äª·Ä±·Ä¨·Ä∫)·Åã ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·Äë·Äï·Ä∫·ÄÄ·Äº·Ä≠·ÄØ·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·Ä´');
        }
        
        // Generate User ID
        const userID = generateUserID();
        console.log('User ID:', userID);
        console.log('Selected Server Index (Least users):', selectedServerIndex);
        
        // Handle profile image
        let profileImageData = null;
        if (profileImage) {
            try {
                profileImageData = await convertImageToBase64(profileImage);
                console.log('Profile image converted successfully');
            } catch (imageError) {
                console.log('Image conversion failed, continuing without image');
            }
        }
        
        // Try to create account on selected server (with least users)
        let accountCreated = false;
        let createdServerIndex = selectedServerIndex;
        
        // First try the server with least users
        const server = SUPABASE_SERVERS[selectedServerIndex];
        const supabaseClient = getSupabaseClient(selectedServerIndex);
        
        console.log(`Trying server ${selectedServerIndex + 1} (Least users: ${await countServerUsers(selectedServerIndex)}/100)`);
        
        const { data, error } = await supabaseClient
            .from('users')
            .insert([
                {
                    user_id: userID,
                    user_name: userName.trim(),
                    profile_image: profileImageData,
                    tokens: 0,
                    coins: 0,
                    crystals: 0,
                    created_at: new Date().toISOString()
                }
            ]);
        
        if (!error) {
            accountCreated = true;
            createdServerIndex = selectedServerIndex;
            console.log(`Account created successfully on server ${selectedServerIndex + 1} (Least users)`);
        } else {
            console.log(`Server ${selectedServerIndex + 1} failed:`, error.message);
            
            // If first server fails, try other servers in order of user count
            const serverStats = [];
            for (let i = 0; i < SUPABASE_SERVERS.length; i++) {
                if (i === selectedServerIndex) continue;
                const userCount = await countServerUsers(i);
                serverStats.push({ serverIndex: i, userCount: userCount });
            }
            
            // Sort by user count (ascending)
            serverStats.sort((a, b) => a.userCount - b.userCount);
            
            for (const stat of serverStats) {
                if (stat.userCount >= 100) continue; // Skip full servers
                
                try {
                    const altSupabaseClient = getSupabaseClient(stat.serverIndex);
                    
                    console.log(`Trying alternative server ${stat.serverIndex + 1} (${stat.userCount}/100 users)`);
                    
                    const { data: data2, error: error2 } = await altSupabaseClient
                        .from('users')
                        .insert([
                            {
                                user_id: userID,
                                user_name: userName.trim(),
                                profile_image: profileImageData,
                                tokens: 0,
                                coins: 0,
                                crystals: 0,
                                created_at: new Date().toISOString()
                            }
                        ]);
                    
                    if (!error2) {
                        accountCreated = true;
                        createdServerIndex = stat.serverIndex;
                        console.log(`Account created successfully on alternative server ${stat.serverIndex + 1}`);
                        break;
                    }
                } catch (serverError) {
                    console.log(`Alternative server ${stat.serverIndex + 1} error`);
                }
            }
        }
        
        if (!accountCreated) {
            throw new Error('·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äõ·Äî·Ä∫·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´ (·ÄÜ·Ä¨·Äó·Ä¨·Äô·Äª·Ä¨·Ä∏·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫)');
        }
        
        // Save to Local Storage
        const userData = {
            userID: userID,
            userName: userName.trim(),
            profileImage: profileImageData,
            tokens: 0,
            coins: 0,
            crystals: 0,
            createdAt: new Date().toISOString(),
            serverIndex: createdServerIndex
        };
        
        localStorage.setItem('gameUserData', JSON.stringify(userData));
        
        // Success - Hide screens and show game
        document.getElementById('account-creation-screen').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'none';
        const gameContainer = document.getElementById('game-container');
        if (gameContainer) {
            gameContainer.style.display = 'block';
        }
        
        // Update UI
        updateResourceDisplay(0, 0, 0);
        
        // Start auto-sync
        startAutoSync();
        
        console.log('Account created successfully on server', createdServerIndex + 1);
        
    } catch (error) {
        errorMsg.textContent = error.message;
        errorMsg.style.display = 'block';
        console.error('Account creation error:', error);
    } finally {
        loading.style.display = 'none';
        createBtn.disabled = false;
    }
}



// ========== INITIALIZE ACCOUNT SYSTEM ==========
function initializeAccountSystem() {
    const existingData = localStorage.getItem('gameUserData');
    
    if (existingData) {
        try {
            const userData = JSON.parse(existingData);
            
            const loadingScreen = document.getElementById('loading-screen');
            const gameContainer = document.getElementById('game-container');
            const loadingImage = document.getElementById('loading-image');
            const loadingCircle = document.getElementById('loading-circle');
            
            if (loadingImage) {
                const randomIndex = Math.floor(Math.random() * loadingImages.length);
                loadingImage.src = loadingImages[randomIndex];
            }
            
            if (loadingScreen) loadingScreen.style.display = 'block';
            if (gameContainer) gameContainer.style.display = 'none';
            if (loadingCircle) loadingCircle.style.display = 'block';
            
            let enterBtn = document.getElementById('enter-btn');
            
            if (enterBtn) {
                enterBtn.style.display = 'none';
                enterBtn.classList.remove('show');
                
                setTimeout(() => {
                    if (loadingCircle) loadingCircle.style.display = 'none';
                    
                    enterBtn.style.display = 'block';
                    enterBtn.classList.add('show');
                    
                    enterBtn.onclick = function() {
                        console.log('Enter button clicked - Existing user');
                        if (loadingScreen) loadingScreen.style.display = 'none';
                        if (gameContainer) gameContainer.style.display = 'block';
                        
                        updateResourceDisplay(userData.tokens, userData.coins, userData.crystals);
                        
                        if (userData.userID) {
                            setTimeout(() => {
                                syncSupabaseToLocal();
                                startAutoSync();
                            }, 1000);
                        }
                    };
                    
                }, 3000);
            } else {
                setTimeout(() => {
                    if (loadingScreen) loadingScreen.style.display = 'none';
                    if (gameContainer) gameContainer.style.display = 'block';
                    updateResourceDisplay(userData.tokens, userData.coins, userData.crystals);
                    startAutoSync();
                }, 3000);
            }
            
            console.log('Existing user - Loading screen shown');
            return;
            
        } catch (e) {
            console.error('Error parsing local data:', e);
            localStorage.removeItem('gameUserData');
        }
    }
    
    const accountScreen = document.getElementById('account-creation-screen');
    const profileCircle = document.getElementById('profile-circle');
    const fileInput = document.getElementById('profile-file-input');
    const uploadBtn = document.getElementById('upload-profile-btn');
    const createBtn = document.getElementById('create-account-btn');
    const nameInput = document.getElementById('user-name');
    
    let selectedImage = null;
    
    setTimeout(() => {
        document.getElementById('loading-screen').style.display = 'none';
        if (accountScreen) accountScreen.style.display = 'flex';
    }, 3000);
    
    if (profileCircle) {
        profileCircle.addEventListener('click', () => {
            if (fileInput) fileInput.click();
        });
    }
    
    if (uploadBtn) {
        uploadBtn.addEventListener('click', () => {
            if (fileInput) fileInput.click();
        });
    }
    
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                console.log('File selected:', file.name, file.type, file.size);
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('·Äï·ÄØ·Ä∂·Ä°·Äõ·ÄΩ·Äö·Ä∫·Ä°·ÄÖ·Ä¨·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏·Äú·ÄΩ·Äî·Ä∫·Ä∏·Äï·Ä´·Äû·Ää·Ä∫ (·Ä°·Äô·Äª·Ä¨·Ä∏·ÄÜ·ÄØ·Ä∂·Ä∏ 5MB)');
                    return;
                }
                
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('JPEG, PNG, GIF, WebP ·Äï·ÄØ·Ä∂·Äñ·Ä≠·ÄØ·ÄÑ·Ä∫·Äû·Ä¨·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´');
                    return;
                }
                
                selectedImage = file;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const emojiDisplay = document.querySelector('.emoji-display');
                    if (emojiDisplay) {
                        emojiDisplay.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    }
                };
                reader.readAsDataURL(file);
                
                alert('·Äï·ÄØ·Ä∂·Äõ·ÄΩ·Ä±·Ä∏·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ');
            }
        });
    }
    
    if (createBtn) {
        createBtn.addEventListener('click', () => {
            const userName = nameInput ? nameInput.value.trim() : '';
            createUserAccount(userName, selectedImage);
        });
    }
    
    if (nameInput) {
        nameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && createBtn) {
                createBtn.click();
            }
        });
    }
}

// ========== START APPLICATION ==========
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeAccountSystem, 100);
});

// ========== LOCAL TO SUPABASE SYNC ==========
async function updateLocalToSupabase(type, amount, operation = 'add') {
    try {
        // Get current data from Local Storage
        let userData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
        
        if (!userData || !userData.userID) {
            console.error('User data not found in local storage');
            return false;
        }
        
        // Calculate new value
        let currentValue = userData[type] || 0;
        let newValue;
        
        switch(operation) {
            case 'add':
                newValue = currentValue + amount;
                break;
            case 'subtract':
                newValue = currentValue - amount;
                if (newValue < 0) newValue = 0;
                break;
            case 'set':
                newValue = amount;
                break;
            default:
                newValue = currentValue + amount;
        }
        
        // Update Local Storage FIRST
        userData[type] = newValue;
        localStorage.setItem('gameUserData', JSON.stringify(userData));
        
        // Update UI IMMEDIATELY
        updateResourceDisplay(userData.tokens, userData.coins, userData.crystals);
        
        // Get user's original server index
        const userServerIndex = userData.serverIndex || 0;
        
        // Sync to user's original server FIRST
        let syncSuccess = false;
        
        if (userServerIndex >= 0 && userServerIndex < SUPABASE_SERVERS.length) {
            try {
                const supabaseClient = getSupabaseClient(userServerIndex);
                const { error } = await supabaseClient
                    .from('users')
                    .update({ [type]: newValue })
                    .eq('user_id', userData.userID);
                
                if (!error) {
                    syncSuccess = true;
                    console.log(`Local ‚Üí Supabase (Server ${userServerIndex + 1}): ${type} updated to ${newValue}`);
                } else {
                    console.log(`User's server ${userServerIndex + 1} sync failed:`, error.message);
                }
            } catch (serverError) {
                console.log(`User's server ${userServerIndex + 1} connection failed`);
            }
        }
        
        // If user's original server fails, try all other servers
        if (!syncSuccess) {
            console.log('Trying all servers for sync...');
            for (let i = 0; i < SUPABASE_SERVERS.length; i++) {
                if (i === userServerIndex) continue; // Skip original server
                
                try {
                    const supabaseClient = getSupabaseClient(i);
                    const { error } = await supabaseClient
                        .from('users')
                        .update({ [type]: newValue })
                        .eq('user_id', userData.userID);
                    
                    if (!error) {
                        syncSuccess = true;
                        console.log(`Local ‚Üí Supabase (Backup Server ${i + 1}): ${type} updated to ${newValue}`);
                        break;
                    }
                } catch (serverError) {
                    console.log(`Backup server ${i + 1} sync failed`);
                }
            }
        }
        
        console.log(`${type} updated: ${currentValue} ‚Üí ${newValue} (Local ‚Üí ${syncSuccess ? 'Supabase' : 'Local Only'})`);
        return syncSuccess;
        
    } catch (error) {
        console.error(`Error updating ${type}:`, error);
        return false;
    }
}

// ========== SUPABASE TO LOCAL SYNC ==========
async function syncSupabaseToLocal() {
    try {
        const userData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
        
        if (!userData.userID) {
            console.log('No user ID found for sync');
            return;
        }
        
        // Get user's original server index
        const userServerIndex = userData.serverIndex || 0;
        
        // Try user's original server first
        if (userServerIndex >= 0 && userServerIndex < SUPABASE_SERVERS.length) {
            try {
                const supabaseClient = getSupabaseClient(userServerIndex);
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('tokens, coins, crystals, user_name, profile_image')
                    .eq('user_id', userData.userID)
                    .single();
                
                if (!error && data) {
                    // Update local storage with Supabase data
                    userData.tokens = data.tokens || userData.tokens || 0;
                    userData.coins = data.coins || userData.coins || 0;
                    userData.crystals = data.crystals || userData.crystals || 0;
                    
                    // Keep other user info if exists in Supabase
                    if (data.user_name) userData.userName = data.user_name;
                    if (data.profile_image) userData.profileImage = data.profile_image;
                    
                    localStorage.setItem('gameUserData', JSON.stringify(userData));
                    
                    // Update UI
                    updateResourceDisplay(userData.tokens, userData.coins, userData.crystals);
                    
                    console.log(`Supabase ‚Üí Local: Synced from user's server ${userServerIndex + 1}`);
                    return;
                }
            } catch (serverError) {
                console.log(`User's server ${userServerIndex + 1} sync failed`);
            }
        }
        
        // Try all other servers if original server fails
        for (let i = 0; i < SUPABASE_SERVERS.length; i++) {
            if (i === userServerIndex) continue; // Skip original server
            
            try {
                const supabaseClient = getSupabaseClient(i);
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('tokens, coins, crystals, user_name, profile_image')
                    .eq('user_id', userData.userID)
                    .single();
                
                if (!error && data) {
                    // Update local storage with Supabase data
                    userData.tokens = data.tokens || userData.tokens || 0;
                    userData.coins = data.coins || userData.coins || 0;
                    userData.crystals = data.crystals || userData.crystals || 0;
                    
                    // Keep other user info if exists in Supabase
                    if (data.user_name) userData.userName = data.user_name;
                    if (data.profile_image) userData.profileImage = data.profile_image;
                    
                    localStorage.setItem('gameUserData', JSON.stringify(userData));
                    
                    // Update UI
                    updateResourceDisplay(userData.tokens, userData.coins, userData.crystals);
                    
                    console.log(`Supabase ‚Üí Local: Synced from backup server ${i + 1}`);
                    return;
                }
            } catch (serverError) {
                console.log(`Supabase server ${i + 1} sync failed`);
            }
        }
        
        console.log('All Supabase servers sync failed, using local data');
        
    } catch (error) {
        console.error('Sync error:', error);
    }
}

// ========== EASY-TO-USE FUNCTIONS ==========
// Update Tokens
async function updateTokenCount(amount, operation = 'add') {
    return await updateLocalToSupabase('tokens', amount, operation);
}

// Update Coins
async function updateCoinCount(amount, operation = 'add') {
    return await updateLocalToSupabase('coins', amount, operation);
}

// Update Crystals
async function updateCrystalCount(amount, operation = 'add') {
    return await updateLocalToSupabase('crystals', amount, operation);
}

// Manual Sync Button (for testing)
async function manualSync() {
    console.log('Manual sync triggered');
    await syncSupabaseToLocal();
}

// Auto-sync every 30 seconds
function startAutoSync() {
    setInterval(() => {
        syncSupabaseToLocal();
    }, 30000); // 30 seconds
}

// ===== LOCAL STORAGE WATCHER =====
let lastLocalData = localStorage.getItem('gameUserData');

setInterval(async () => {
    const currentData = localStorage.getItem('gameUserData');
    if (!currentData || currentData === lastLocalData) return;

    lastLocalData = currentData;

    try {
        const data = JSON.parse(currentData);
        if (!data.userID) return;

        // Get user's server index
        const userServerIndex = data.serverIndex || 0;
        
        // Try user's server first
        if (userServerIndex >= 0 && userServerIndex < SUPABASE_SERVERS.length) {
            try {
                const supabaseClient = getSupabaseClient(userServerIndex);
                await supabaseClient
                    .from('users')
                    .update({
                        tokens: data.tokens || 0,
                        coins: data.coins || 0,
                        crystals: data.crystals || 0
                    })
                    .eq('user_id', data.userID);
                console.log('üì§ Local ‚Üí Supabase auto synced (User\'s server)');
                return;
            } catch (e) {
                console.log('User\'s server auto-sync failed');
            }
        }
        
        // Try all servers if user's server fails
        for (let i = 0; i < SUPABASE_SERVERS.length; i++) {
            if (i === userServerIndex) continue;
            
            try {
                const supabaseClient = getSupabaseClient(i);
                await supabaseClient
                    .from('users')
                    .update({
                        tokens: data.tokens || 0,
                        coins: data.coins || 0,
                        crystals: data.crystals || 0
                    })
                    .eq('user_id', data.userID);
                console.log(`üì§ Local ‚Üí Supabase auto synced (Backup server ${i + 1})`);
                break;
            } catch (e) {}
        }

    } catch (err) {
        console.error('Watcher error', err);
    }
}, 1500); // 1.5 sec

// ========== EXPORT FUNCTIONS ==========
// Make functions available globally
window.updateTokenCount = updateTokenCount;
window.updateCoinCount = updateCoinCount;
window.updateCrystalCount = updateCrystalCount;
window.syncSupabaseToLocal = syncSupabaseToLocal;
window.manualSync = manualSync;

// Utility function to check current resources
window.checkResources = function() {
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
    console.log('Current Resources:', {
        tokens: userData.tokens || 0,
        coins: userData.coins || 0,
        crystals: userData.crystals || 0,
        userID: userData.userID || 'No ID',
        serverIndex: userData.serverIndex || 0
    });
    return userData;
};

// ===== TASK SYSTEM =====
// Task Screen HTML
const taskScreenHTML = `
<div class="task-screen" id="task-screen" style="display:none;">
    <div class="task-background"></div>
    
    <div class="task-container">
        <button class="task-back-btn" id="task-back-btn">Back</button>
        
        <div class="task-header">
            <h1 class="task-title">Task ·Äô·Äª·Ä¨·Ä∏</h1>
            <p class="task-subtitle">Task ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏ Token ·Äô·Äª·Ä¨·Ä∏·Äõ·Äö·Ä∞·Äï·Ä´</p>
        </div>
        
        <div class="task-card featured-task">
            <div class="task-card-header">
                <div class="task-icon">
                    <img src="https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" class="token-icon-small">
                </div>
                <div class="task-info">
                    <h3 class="task-name">·Äî·Ä¨·Äõ·ÄÆ·Ä°·Äú·Ä≠·ÄØ·ÄÄ·Ä∫ Token</h3>
                    <p class="task-reward">
                        <img src="https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" class="token-icon-tiny">
                        <span>+3 Token</span>
                    </p>
                </div>
                <div class="task-timer" id="three-hour-timer">
                    03:00:00
                </div>
            </div>
            
            <p class="task-description">3 ·Äî·Ä¨·Äõ·ÄÆ·Äê·ÄÖ·Ä∫·ÄÄ·Äº·Ä≠·Äô·Ä∫ 3 Token ·Ä°·Äú·Ä≠·ÄØ·Ä°·Äú·Äª·Ä±·Ä¨·ÄÄ·Ä∫·Äõ·Äõ·Äæ·Ä≠·Äô·Ää·Ä∫</p>
            
            <div class="task-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="timer-progress"></div>
                </div>
                <div class="progress-time">
                    <span id="time-remaining">3:00:00 ·ÄÄ·Äª·Äî·Ä∫·Äõ·Äæ·Ä≠</span>
                </div>
            </div>
            
            <button class="claim-btn" id="three-hour-claim" disabled>
                <span class="btn-text">·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·ÄÄ·Äª·Äî·Ä∫·Äõ·Äæ·Ä≠·Äï·Ä´·Äû·Ä±·Ä∏·Äû·Ää·Ä∫</span>
                <span class="btn-tokens">
                    <img src="https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" class="token-icon-btn">
                    <span>+3</span>
                </span>
            </button>
        </div>
        
        <!-- NEW: Share Tasks Section -->
        <div class="task-section share-task-section">
            <h2 class="section-title">Share Tasks</h2>
            <p class="task-subtitle">Telegram ·ÄÄ·Ä≠·ÄØ Share ·Äï·Äº·ÄÆ·Ä∏ Token ·Äô·Äª·Ä¨·Ä∏·Äõ·Äö·Ä∞·Äï·Ä´</p>
            
            <div class="task-list" id="share-tasks">
                <!-- Share tasks will be loaded here -->
            </div>
        </div>
        
        <div class="task-section">
            <h2 class="section-title">Telegram Channel Tasks</h2>
            <p class="task-subtitle">Channel ·Äù·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏ 5 Token ·Äõ·Äö·Ä∞·Äï·Ä´</p>
            
            <div class="task-list" id="telegram-tasks">
                <!-- Telegram tasks will be loaded here -->
            </div>
        </div>
        
        <div class="task-section">
            <h2 class="section-title">YouTube Tasks</h2>
            <p class="task-subtitle">Subscribe ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏ 5 Token ·Äõ·Äö·Ä∞·Äï·Ä´</p>
            
            <div class="task-list" id="youtube-tasks">
                <!-- YouTube tasks will be loaded here -->
            </div>
        </div>
    </div>
</div>
`;

// Task Screen CSS
const taskScreenCSS = `
<style>
/* Task Screen Styles */
.task-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1000;
    display: none;
}

.task-background {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%);
    background-size: 400% 400%;
    animation: gradientBG 15s ease infinite;
}

@keyframes gradientBG {
    0% { background-position: 0% 50% }
    50% { background-position: 100% 50% }
    100% { background-position: 0% 50% }
}

.task-container {
    position: relative;
    width: 100%;
    height: 100%;
    padding: 20px;
    overflow-y: auto;
    padding-bottom: 50px;
}

/* Back Button */
.task-back-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 10px 25px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    z-index: 10;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.task-back-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

/* Task Header */
.task-header {
    text-align: center;
    margin: 40px 0 30px;
    padding-top: 40px;
}

.task-title {
    color: white;
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.task-subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1rem;
}

/* Task Card - All same size */
.task-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    min-height: 220px;
    display: flex;
    flex-direction: column;
}

.featured-task {
    background: rgba(41, 128, 185, 0.2);
    border: 1px solid rgba(52, 152, 219, 0.3);
}

.task-card-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    flex-shrink: 0;
}

.task-icon {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    flex-shrink: 0;
    padding: 5px;
}

.token-icon-small {
    width: 40px;
    height: 40px;
    object-fit: contain;
}

.task-info {
    flex: 1;
    min-width: 0;
}

.task-name {
    color: white;
    font-size: 1.2rem;
    margin: 0 0 5px 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.task-reward {
    color: #FFD700;
    font-size: 1rem;
    font-weight: bold;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 5px;
}

.token-icon-tiny {
    width: 16px;
    height: 16px;
    object-fit: contain;
}

.task-timer {
    background: rgba(0, 0, 0, 0.3);
    padding: 8px 15px;
    border-radius: 10px;
    color: #FFD700;
    font-size: 1.1rem;
    font-weight: bold;
    font-family: monospace;
    border: 1px solid rgba(255, 215, 0, 0.3);
    flex-shrink: 0;
}

.task-description {
    color: rgba(255, 255, 255, 0.8);
    margin: 0 0 20px 0;
    font-size: 0.95rem;
    flex: 1;
}

/* Progress Bar */
.task-progress {
    margin-bottom: 20px;
    flex-shrink: 0;
}

.progress-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.progress-time {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    text-align: center;
}

/* Claim Button */
.claim-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    flex-shrink: 0;
}

.claim-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #66BB6A, #388E3C);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

.claim-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    cursor: not-allowed;
    box-shadow: none;
}

.btn-text {
    font-size: 0.95rem;
}

.btn-tokens {
    color: #FFD700;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
}

.token-icon-btn {
    width: 20px;
    height: 20px;
    object-fit: contain;
}

/* Task Section */
.task-section {
    margin-bottom: 30px;
}

.section-title {
    color: white;
    font-size: 1.5rem;
    margin-bottom: 5px;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
}

/* Task List */
.task-list {
    display: grid;
    gap: 15px;
    margin-bottom: 20px;
}

.task-item {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 15px;
    padding: 18px;
    display: flex;
    align-items: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
    min-height: 110px;
}

.task-item:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateY(-2px);
}

.task-item.completed {
    background: rgba(76, 175, 80, 0.1);
    border-color: rgba(76, 175, 80, 0.3);
}

.task-channel-icon {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-weight: bold;
    color: white;
    font-size: 12px;
    flex-shrink: 0;
}

.task-details {
    flex: 1;
    min-width: 0;
}

.task-channel-name {
    color: white;
    font-size: 1rem;
    margin-bottom: 5px;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.task-channel-link {
    color: #64B5F6;
    font-size: 0.85rem;
    text-decoration: none;
    word-break: break-all;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
    margin-bottom: 5px;
}

.task-channel-link:hover {
    text-decoration: underline;
}

.task-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
    flex-shrink: 0;
    min-width: 120px;
}

.task-reward-amount {
    color: #FFD700;
    font-weight: bold;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.task-token-icon {
    width: 16px;
    height: 16px;
    object-fit: contain;
}

.task-join-btn {
    background: linear-gradient(135deg, #2196F3, #0D47A1);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 110px;
}

.task-join-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #42A5F5, #1565C0);
    transform: translateY(-1px);
}

.task-join-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    cursor: not-allowed;
}

/* NEW: Share Tasks Section Styles */
.share-task-section .task-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.share-task-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 25px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    min-height: 200px;
    display: flex;
    flex-direction: column;
}

.share-task-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    flex-shrink: 0;
}

.share-icon {
    width: 50px;
    height: 50px;
    background: rgba(33, 150, 243, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    flex-shrink: 0;
    padding: 5px;
}

.share-icon svg {
    width: 30px;
    height: 30px;
    fill: #2196F3;
}

.share-task-info {
    flex: 1;
    min-width: 0;
}

.share-task-name {
    color: white;
    font-size: 1.2rem;
    margin: 0 0 5px 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.share-task-reward {
    color: #FFD700;
    font-size: 1rem;
    font-weight: bold;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 5px;
}

.share-task-description {
    color: rgba(255, 255, 255, 0.8);
    margin: 0 0 20px 0;
    font-size: 0.95rem;
    flex: 1;
}

.share-task-progress {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
    flex-shrink: 0;
}

.share-progress-text {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    display: flex;
    justify-content: space-between;
}

.share-count {
    color: #4CAF50;
    font-weight: bold;
}

.share-progress-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.share-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #2196F3, #0D47A1);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.share-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #2196F3, #0D47A1);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
    flex-shrink: 0;
}

.share-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #42A5F5, #1565C0);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
}

.share-btn:disabled {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.5);
    cursor: not-allowed;
    box-shadow: none;
}

.share-btn-icon {
    font-size: 18px;
}

/* Mobile Responsive */
@media (max-width: 600px) {
    .task-title {
        font-size: 2rem;
    }
    
    .task-container {
        padding: 15px;
    }
    
    .task-card {
        padding: 20px;
        min-height: 200px;
    }
    
    .task-card-header {
        flex-wrap: wrap;
    }
    
    .task-timer {
        margin-top: 10px;
        width: 100%;
        text-align: center;
    }
    
    .claim-btn {
        flex-direction: column;
        gap: 5px;
        text-align: center;
    }
    
    .btn-tokens {
        justify-content: center;
    }
    
    .task-item {
        flex-wrap: wrap;
        min-height: 130px;
    }
    
    .task-actions {
        width: 100%;
        margin-top: 10px;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        min-width: 100%;
    }
    
    .task-channel-icon {
        width: 40px;
        height: 40px;
    }
    
    .task-channel-link {
        font-size: 0.8rem;
        -webkit-line-clamp: 2;
        line-height: 1.3;
    }
    
    .share-task-card {
        padding: 20px;
        min-height: 180px;
    }
    
    .share-icon {
        width: 40px;
        height: 40px;
    }
    
    .share-icon svg {
        width: 24px;
        height: 24px;
    }
    
    .share-task-name {
        font-size: 1.1rem;
    }
    
    .share-btn {
        padding: 12px;
        font-size: 0.95rem;
    }
}
</style>
`;

// Task Data (Updated with new share tasks)
const tasksData = {
    telegramTasks: [
        { name: "Moonton Company MM", link: "https://t.me/MoontonCompamyMM", reward: 5 },
        { name: "Starlar Company", link: "https://t.me/StarlarCompany", reward: 5 },
        { name: "stw27925", link: "https://t.me/stw27925", reward: 5 },
        { name: "MythicMart 2", link: "https://t.me/MythicMart_2", reward: 5 },
        { name: "johnny game shop", link: "https://t.me/johnny_game_shop", reward: 5 },
        { name: "Max Diamond Shop", link: "https://t.me/MaxDiamondShop", reward: 5 }
    ],
    youtubeTasks: [
        { name: "Starlar YouTube", link: "https://youtube.com/@starlar.1", reward: 5 },
        { name: "Max Gaming Myanmar", link: "https://youtube.com/@maxgamingmyanmar1", reward: 5 },
        { name: "Monster Hunter Gaming", link: "https://youtube.com/@monsterhuntergaming668", reward: 5 }
    ],
    // NEW SHARE TASKS
    shareTasks: [
        { 
            name: "5 ·ÄÅ·Ä´ Share ·Äï·Ä´", 
            description: "·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·ÄÄ·Ä≠·ÄØ 5 ·ÄÅ·Ä´ Share ·Äï·Ä´",
            shareMessage: "MLBB Diamonds ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ·Ä°·ÄÅ·Äô·Ä≤·Ä∑·Äõ·Äö·Ä∞·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´\nhttps://starlar1.github.io/SC-Event-Season-3-Project-Next/",
            requiredCount: 5,
            reward: 5,
            completedCount: 0
        },
        { 
            name: "10 ·ÄÅ·Ä´ Share ·Äï·Ä´", 
            description: "·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·ÄÄ·Ä≠·ÄØ 10 ·ÄÅ·Ä´ Share ·Äï·Ä´",
            shareMessage: "MLBB Diamonds ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ·Ä°·ÄÅ·Äô·Ä≤·Ä∑·Äõ·Äö·Ä∞·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´\nhttps://starlar1.github.io/SC-Event-Season-3-Project-Next/",
            requiredCount: 10,
            reward: 8,
            completedCount: 0
        }
    ]
};

// Task System Variables
let taskScreen, taskBackBtn, threeHourTimer, timerProgress, timeRemaining, threeHourClaim;
let timerInterval;
let lastClaimTime = null;
let THREE_HOURS = 3 * 60 * 60 * 1000; // 3 hours in milliseconds

// Store checking tasks to prevent duplicates
const checkingTasks = new Set();

// Initialize Task System
function initializeTaskSystem() {
    // Insert HTML and CSS
    document.body.insertAdjacentHTML('beforeend', taskScreenHTML);
    document.head.insertAdjacentHTML('beforeend', taskScreenCSS);
    
    // Get elements
    taskScreen = document.getElementById('task-screen');
    taskBackBtn = document.getElementById('task-back-btn');
    threeHourTimer = document.getElementById('three-hour-timer');
    timerProgress = document.getElementById('timer-progress');
    timeRemaining = document.getElementById('time-remaining');
    threeHourClaim = document.getElementById('three-hour-claim');
    
    // Load saved data
    loadTaskData();
    
    // Setup event listeners
    setupTaskEvents();
    
    // Generate task lists
    generateTaskLists();
    generateShareTasks(); // NEW: Generate share tasks
    
    // Start timer
    startTimer();
}

// Load task data from localStorage
function loadTaskData() {
    const savedData = localStorage.getItem('taskSystemData');
    if (savedData) {
        const data = JSON.parse(savedData);
        lastClaimTime = data.lastClaimTime ? new Date(data.lastClaimTime) : null;
        
        // Load completed tasks
        const completedTasks = data.completedTasks || { telegram: [], youtube: [] };
        tasksData.telegramTasks.forEach(task => {
            task.completed = completedTasks.telegram.includes(task.link);
        });
        tasksData.youtubeTasks.forEach(task => {
            task.completed = completedTasks.youtube.includes(task.link);
        });
        
        // Load share tasks progress
        const shareTasksProgress = data.shareTasksProgress || [];
        tasksData.shareTasks.forEach((task, index) => {
            const savedTask = shareTasksProgress.find(t => t.index === index);
            if (savedTask) {
                task.completedCount = savedTask.completedCount || 0;
            }
        });
        
        // Load checking tasks
        const savedCheckingTasks = data.checkingTasks || [];
        savedCheckingTasks.forEach(taskId => {
            checkingTasks.add(taskId);
        });
    }
}

// Save task data to localStorage
function saveTaskData() {
    const completedTelegram = tasksData.telegramTasks
        .filter(task => task.completed)
        .map(task => task.link);
    const completedYoutube = tasksData.youtubeTasks
        .filter(task => task.completed)
        .map(task => task.link);
    
    // Save share tasks progress
    const shareTasksProgress = tasksData.shareTasks.map((task, index) => ({
        index: index,
        completedCount: task.completedCount || 0
    }));
    
    const data = {
        lastClaimTime: lastClaimTime ? lastClaimTime.toISOString() : null,
        completedTasks: {
            telegram: completedTelegram,
            youtube: completedYoutube
        },
        shareTasksProgress: shareTasksProgress,
        checkingTasks: Array.from(checkingTasks)
    };
    
    localStorage.setItem('taskSystemData', JSON.stringify(data));
}

// Setup event listeners
function setupTaskEvents() {
    // Task button click
    document.getElementById('task-btn').addEventListener('click', function() {
        document.getElementById('game-container').style.display = 'none';
        taskScreen.style.display = 'block';
    });

    // Back button
    taskBackBtn.addEventListener('click', function() {
        taskScreen.style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
    });

    // 3-hour claim button
    threeHourClaim.addEventListener('click', function() {
        claimThreeHourReward();
    });
}

// Generate task lists
function generateTaskLists() {
    const telegramList = document.getElementById('telegram-tasks');
    const youtubeList = document.getElementById('youtube-tasks');
    
    // Clear existing lists
    telegramList.innerHTML = '';
    youtubeList.innerHTML = '';
    
    // Generate Telegram tasks
    tasksData.telegramTasks.forEach((task, index) => {
        const taskItem = createTaskItem(task, 'telegram', index);
        telegramList.appendChild(taskItem);
    });
    
    // Generate YouTube tasks
    tasksData.youtubeTasks.forEach((task, index) => {
        const taskItem = createTaskItem(task, 'youtube', index);
        youtubeList.appendChild(taskItem);
    });
}

// NEW: Generate share tasks list
function generateShareTasks() {
    const shareList = document.getElementById('share-tasks');
    if (!shareList) return;
    
    shareList.innerHTML = '';
    
    tasksData.shareTasks.forEach((task, index) => {
        const taskItem = createShareTaskItem(task, index);
        shareList.appendChild(taskItem);
    });
}

// Create task item element
function createTaskItem(task, type, index) {
    const div = document.createElement('div');
    div.className = `task-item ${task.completed ? 'completed' : ''}`;
    div.dataset.type = type;
    div.dataset.index = index;
    div.dataset.taskId = `${type}-${index}`;
    
    // Shorten YouTube links for display
    let displayLink = task.link;
    if (type === 'youtube') {
        displayLink = task.link.replace('https://youtube.com/@', '');
        displayLink = '@' + displayLink;
    }
    
    div.innerHTML = `
        <div class="task-channel-icon">${type === 'telegram' ? 'TG' : 'YT'}</div>
        <div class="task-details">
            <div class="task-channel-name">${task.name}</div>
            <a href="${task.link}" target="_blank" class="task-channel-link" title="${task.link}">${displayLink}</a>
        </div>
        <div class="task-actions">
            <div class="task-reward-amount">
                <img src="https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" class="task-token-icon">
                <span>+${task.reward}</span>
            </div>
            <button class="task-join-btn" ${task.completed ? 'disabled' : ''}>
                ${task.completed ? 'Completed' : 'Join Now'}
            </button>
        </div>
    `;
    
    // Add click event to button
    const joinBtn = div.querySelector('.task-join-btn');
    
    if (!task.completed) {
        joinBtn.addEventListener('click', function() {
            claimTaskReward(type, index, task, joinBtn);
        });
    }
    
    return div;
}

// NEW: Create share task item
function createShareTaskItem(task, index) {
    const div = document.createElement('div');
    div.className = 'share-task-card';
    div.dataset.index = index;
    
    // Load saved progress
    const savedProgress = JSON.parse(localStorage.getItem(`shareTask_${index}`) || '{"completedCount":0}');
    task.completedCount = savedProgress.completedCount || 0;
    
    const progressPercent = (task.completedCount / task.requiredCount) * 100;
    const isCompleted = task.completedCount >= task.requiredCount;
    
    div.innerHTML = `
        <div class="share-task-header">
            <div class="share-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                </svg>
            </div>
            <div class="share-task-info">
                <h3 class="share-task-name">${task.name}</h3>
                <p class="share-task-reward">
                    <img src="https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" class="token-icon-tiny">
                    <span>+${task.reward} Token</span>
                </p>
            </div>
        </div>
        
        <p class="share-task-description">${task.description}</p>
        
        <div class="share-task-progress">
            <div class="share-progress-text">
                <span>Share ·Äï·Äº·ÄÆ·Ä∏·Äû·Ää·Ä∑·Ä∫·Ä°·Äõ·Ä±·Ä°·Äê·ÄΩ·ÄÄ·Ä∫:</span>
                <span class="share-count">${task.completedCount}/${task.requiredCount}</span>
            </div>
            <div class="share-progress-bar">
                <div class="share-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
        </div>
        
        <button class="share-btn" ${isCompleted ? 'disabled' : ''}>
            <span class="share-btn-icon"></span>
            <span class="btn-text">${isCompleted ? 'Completed' : 'Share Now'}</span>
        </button>
    `;
    
    // Add click event to button
    const shareBtn = div.querySelector('.share-btn');
    
    if (!isCompleted) {
        shareBtn.addEventListener('click', function() {
            shareToTelegram(task, index, shareBtn, div);
        });
    }
    
    return div;
}

// Claim task reward
function claimTaskReward(type, index, task, button) {
    if (task.completed) {
        alert('·Ä§ Task ·ÄÄ·Ä≠·ÄØ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äû·Ä¨·Ä∏·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫');
        return;
    }
    
    const taskId = `${type}-${index}`;
    
    // Check if already checking
    if (checkingTasks.has(taskId)) {
        alert('·Ä§ Task ·ÄÄ·Ä≠·ÄØ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫·Åã ·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´·Åã');
        return;
    }
    
    // Add to checking set
    checkingTasks.add(taskId);
    saveTaskData();
    
    // Open link in new tab
    window.open(task.link, '_blank');
    
    // Start 10-second delay silently
    setTimeout(() => {
        // Mark as completed
        task.completed = true;
        checkingTasks.delete(taskId);
        
        // Update token count
        addTokens(task.reward);
        
        // Find and update UI
        const taskItems = document.querySelectorAll(`[data-task-id="${taskId}"]`);
        taskItems.forEach(taskItem => {
            taskItem.classList.add('completed');
            const btn = taskItem.querySelector('.task-join-btn');
            btn.textContent = 'Completed';
            btn.disabled = true;
        });
        
        // Save to localStorage
        saveTaskData();
        
        // Show success message
        showTaskSuccessMessage(task.reward);
    }, 10000); // 10 seconds delay
}

// NEW: Share to Telegram function
function shareToTelegram(task, index, button, card) {
    // Create share URL
    const shareText = encodeURIComponent(task.shareMessage);
    const telegramShareURL = `https://t.me/share/url?url=&text=${shareText}`;
    
    // Open Telegram share dialog
    window.open(telegramShareURL, '_blank', 'width=600,height=400');
    
    // Disable button temporarily
    button.disabled = true;
    button.innerHTML = '<span class="btn-text">·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´...</span>';
    
    // Ask user to confirm after sharing
    setTimeout(() => {
        const confirmed = confirm(`·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç Share ·Äú·ÄØ·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äï·Ä´·ÄÄ "OK" ·ÄÄ·Ä≠·ÄØ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´·Åã\n\n·Äô·Äæ·Äê·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫: ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·ÄÖ·ÄΩ·Ä¨ Share ·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äû·Ää·Ä∫`);
        
        if (confirmed) {
            // Increase share count
            task.completedCount++;
            
            // Save progress
            localStorage.setItem(`shareTask_${index}`, JSON.stringify({
                completedCount: task.completedCount
            }));
            
            // Update UI
            updateShareTaskUI(task, index, card);
            
            // Check if task is completed
            if (task.completedCount >= task.requiredCount) {
                // Give reward
                addTokens(task.reward);
                
                // Show success message
                showTaskSuccessMessage(task.reward);
                
                // Mark as completed
                button.disabled = true;
                button.innerHTML = '<span class="btn-text">Completed</span>';
                
                // Save task data
                saveTaskData();
            } else {
                // Save task data for partial progress
                saveTaskData();
                
                // Re-enable button for next share
                button.disabled = false;
                button.innerHTML = '<span class="btn-text">Share Now</span>';
            }
        } else {
            // User cancelled, re-enable button
            button.disabled = false;
            button.innerHTML = '<span class="btn-text">Share Now</span>';
        }
        
    }, 3000); // 3 seconds delay for sharing
}

// NEW: Update share task UI
function updateShareTaskUI(task, index, card) {
    const progressPercent = (task.completedCount / task.requiredCount) * 100;
    const isCompleted = task.completedCount >= task.requiredCount;
    
    // Update progress bar
    const progressFill = card.querySelector('.share-progress-fill');
    if (progressFill) {
        progressFill.style.width = `${progressPercent}%`;
    }
    
    // Update count
    const countElement = card.querySelector('.share-count');
    if (countElement) {
        countElement.textContent = `${task.completedCount}/${task.requiredCount}`;
    }
    
    // Update button if completed
    if (isCompleted) {
        const button = card.querySelector('.share-btn');
        if (button) {
            button.disabled = true;
            button.innerHTML = '<span class="share-btn-icon"></span><span class="btn-text">Completed</span>';
        }
    }
}

// Show success message
function showTaskSuccessMessage(reward) {
    // Create success message element
    const successMsg = document.createElement('div');
    successMsg.className = 'task-success-message';
    successMsg.innerHTML = `
        <div class="success-content">
            <div class="success-icon">‚úì</div>
            <div class="success-text">Congratulations!</div>
            <div class="success-tokens">
                <img src="https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" class="token-icon-success">
                <span>+${reward} Tokens Received</span>
            </div>
        </div>
    `;
    
    // Add styles for success message
    const successStyles = `
        <style>
        .task-success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }
        
        .success-content {
            background: rgba(76, 175, 80, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            min-width: 250px;
        }
        
        .success-icon {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 10px;
        }
        
        .success-text {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .success-tokens {
            color: #FFD700;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .token-icon-success {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        </style>
    `;
    
    // Add styles if not already added
    if (!document.querySelector('.task-success-styles')) {
        const styleEl = document.createElement('style');
        styleEl.className = 'task-success-styles';
        styleEl.textContent = successStyles;
        document.head.appendChild(styleEl);
    }
    
    document.body.appendChild(successMsg);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (successMsg.parentNode) {
            successMsg.remove();
        }
    }, 3000);
}

// Start 3-hour timer
function startTimer() {
    // Clear existing interval
    if (timerInterval) clearInterval(timerInterval);
    
    // Update timer immediately
    updateTimer();
    
    // Update every second
    timerInterval = setInterval(updateTimer, 1000);
}

// Update timer display
function updateTimer() {
    const now = new Date().getTime();
    
    if (!lastClaimTime) {
        // First time, timer is ready
        lastClaimTime = new Date(now - THREE_HOURS);
        saveTaskData();
    }
    
    const nextClaimTime = lastClaimTime.getTime() + THREE_HOURS;
    const timeLeft = nextClaimTime - now;
    
    if (timeLeft <= 0) {
        // Time's up, ready to claim
        threeHourTimer.textContent = '00:00:00';
        timeRemaining.textContent = 'Claim Now!';
        timerProgress.style.width = '100%';
        threeHourClaim.disabled = false;
        threeHourClaim.querySelector('.btn-text').textContent = 'Claim 3 Token';
    } else {
        // Still time remaining
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        // Update timer display
        const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        threeHourTimer.textContent = timeStr;
        timeRemaining.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} ·ÄÄ·Äª·Äî·Ä∫·Äõ·Äæ·Ä≠`;
        
        // Update progress bar
        const progress = ((THREE_HOURS - timeLeft) / THREE_HOURS) * 100;
        timerProgress.style.width = `${progress}%`;
        
        // Disable claim button
        threeHourClaim.disabled = true;
        threeHourClaim.querySelector('.btn-text').textContent = '·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·ÄÄ·Äª·Äî·Ä∫·Äõ·Äæ·Ä≠·Äï·Ä´·Äû·Ä±·Ä∏·Äû·Ää·Ä∫';
    }
}

// Claim 3-hour reward
function claimThreeHourReward() {
    const now = new Date().getTime();
    const nextClaimTime = lastClaimTime.getTime() + THREE_HOURS;
    
    if (now < nextClaimTime) {
        alert('·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫·Äô·Äï·Äº·Ää·Ä∑·Ä∫·Äû·Ä±·Ä∏·Äï·Ä´·Åã ·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Äï·Äº·ÄÆ·Ä∏ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´·Åã');
        return;
    }
    
    // Update last claim time
    lastClaimTime = new Date();
    
    // Add tokens
    addTokens(3);
    
    // Update timer
    updateTimer();
    
    // Save to localStorage
    saveTaskData();
    
    // Show success message
    showTaskSuccessMessage(3);
}

// Add tokens to user account
function addTokens(amount) {
    // Use existing updateTokenCount function from your main code
    if (typeof window.updateTokenCount === 'function') {
        window.updateTokenCount(amount, 'add');
    } else {
        // Fallback if function doesn't exist
        const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"tokens":0,"coins":0,"crystals":0}');
        userData.tokens = (userData.tokens || 0) + amount;
        localStorage.setItem('gameUserData', JSON.stringify(userData));
        
        // Update UI
        const tokenElement = document.getElementById('token-count');
        if (tokenElement) {
            tokenElement.textContent = userData.tokens;
        }
    }
}

// Initialize task system when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeTaskSystem, 100);
});

// ===== EXCHANGE SYSTEM FULL SCRIPT =====
const mainExchangeScreenHTML = `
<div class="main-exchange-screen" id="main-exchange-screen" style="display:none;">
    <div class="main-exchange-background"></div>
    
    <div class="main-exchange-content">
        <!-- Back Button - same as coins box -->
        <button class="coins-back-btn" id="main-exchange-back-btn">
            <svg class="back-icon" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Back
        </button>
        
        <!-- Clickable Chat Bubble at Bottom -->
        <div class="clickable-chat-bubble" id="clickable-chat-bubble">
            <span id="main-exchange-chat-text">Coins ·Äñ·Äº·ÄÑ·Ä∑·Ä∫·Äú·Ä≤·Äô·Äö·Ä∫·ÄÜ·Ä≠·ÄØ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´</span>
        </div>
    </div>
</div>

<style>
/* Main Exchange Screen Styles */
.main-exchange-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1000;
    display: none;
}

.main-exchange-background {
    position: absolute;
    width: 100%;
    height: 100%;
    background: url("https://i.ibb.co/bjbR02z3/In-Shot-20251201-104808146.jpg") center no-repeat;
    background-size: cover;
    filter: brightness(0.9);
}

.main-exchange-content {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
    padding-bottom: 50px;
}

/* Back Button - same as coins box */
.coins-back-btn {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(52, 152, 219, 0.9);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    z-index: 10;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.coins-back-btn:hover {
    background: rgba(41, 128, 185, 0.9);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
}

.back-icon {
    width: 18px;
    height: 18px;
    fill: currentColor;
}

/* Clickable Chat Bubble at Bottom */
.clickable-chat-bubble {
    background: rgba(0, 0, 0, 0.45);
    color: #ffffff;
    padding: 18px 30px;
    border-radius: 22px;
    font-size: 20px;
    font-weight: 600;
    text-align: center;
    max-width: 90%;
    min-height: 60px;
    line-height: 1.5;
    box-shadow: 0 8px 30px rgba(0,0,0,0.35);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border: 2px solid rgba(255,255,255,0.18);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    animation: pulse 2s infinite;
    margin-bottom: 30px;
}

.clickable-chat-bubble:hover {
    background: rgba(0, 0, 0, 0.55);
    transform: scale(1.05);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 12px 40px rgba(0,0,0,0.45);
}

.clickable-chat-bubble:active {
    transform: scale(0.98);
}

@keyframes pulse {
    0% { box-shadow: 0 8px 30px rgba(0,0,0,0.35); }
    50% { box-shadow: 0 8px 30px rgba(255,215,0,0.4); }
    100% { box-shadow: 0 8px 30px rgba(0,0,0,0.35); }
}

/* Mobile Responsive */
@media (max-width: 600px) {
    .clickable-chat-bubble {
        font-size: 18px;
        padding: 15px 25px;
    }
    
    .coins-back-btn {
        padding: 8px 16px;
        font-size: 13px;
    }
}
</style>
`;

// ===== EXCHANGE ITEMS SCREEN =====
const exchangeItemsScreenHTML = `
<div class="exchange-items-screen" id="exchange-items-screen" style="display:none;">
    <div class="exchange-items-background"></div>
    
    <div class="exchange-items-content">
        <!-- Back Button - same as coins box -->
        <button class="coins-back-btn" id="exchange-items-back-btn">
            <svg class="back-icon" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Back
        </button>
        
        <!-- Exchange Items Grid -->
        <div class="exchange-grid-container" id="exchange-grid-container">
            <!-- Items will be loaded here dynamically -->
        </div>
    </div>
</div>

<style>
/* Exchange Items Screen Styles */
.exchange-items-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1100;
    display: none;
}

.exchange-items-background {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
}

.exchange-items-content {
    position: relative;
    width: 100%;
    height: 100%;
    padding: 20px;
    overflow-y: auto;
    padding-bottom: 30px;
    padding-top: 70px;
}

/* Exchange Grid */
.exchange-grid-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
}

.exchange-grid-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

/* Exchange Item Card - Square Full Size Images */
.exchange-item-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
    display: flex;
    flex-direction: column;
    aspect-ratio: 1;
    position: relative;
}

.exchange-item-card:hover:not(.disabled) {
    transform: translateY(-5px);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35);
}

.exchange-item-card.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    filter: grayscale(0.8);
}

/* Square Image Container - Full Size */
.exchange-item-image {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
}

.exchange-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.exchange-item-card:hover:not(.disabled) .exchange-item-image img {
    transform: scale(1.05);
}

/* Item Details Overlay */
.exchange-item-details {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.exchange-item-name {
    color: white;
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 5px;
    text-align: center;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
}

.exchange-item-cost {
    color: #FFD700;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.8);
}

.exchange-item-cost img {
    width: 16px;
    height: 16px;
    object-fit: contain;
}

.exchange-item-btn {
    display: none;
}

/* Form Modal Styles */
.exchange-form-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1200;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
}

.exchange-form-modal.show {
    display: flex;
}

.modal-content {
    position: relative;
    background: linear-gradient(135deg, rgba(30, 136, 229, 0.95) 0%, rgba(33, 150, 243, 0.95) 100%);
    backdrop-filter: blur(25px);
    border-radius: 20px;
    width: 100%;
    max-width: 350px;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
    animation: modalSlideUp 0.3s ease;
    margin: 0 20px;
}

@keyframes modalSlideUp {
    from {
        opacity: 0;
        transform: translateY(50px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 20px 20px 0 0;
}

.modal-header h3 {
    color: white;
    margin: 0;
    font-size: 16px;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
}

.modal-close-btn {
    background: rgba(255, 255, 255, 0.15);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    border-radius: 50%;
    line-height: 1;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: rotate(90deg);
}

.modal-body {
    padding: 20px;
}

.selected-item-info {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
}

.item-preview {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    overflow: hidden;
    flex-shrink: 0;
    border: 2px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.item-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-details h4 {
    color: white;
    margin: 0 0 8px 0;
    font-size: 14px;
    font-weight: 600;
}

.item-cost-display {
    color: #FFD700;
    font-size: 13px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 500;
}

.cost-icon-small {
    width: 14px;
    height: 14px;
    object-fit: contain;
}

/* Form Styles - Small, All visible at once */
#exchange-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.form-group label {
    color: rgba(255, 255, 255, 0.95);
    font-size: 11px;
    font-weight: 500;
    margin-left: 3px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.form-group input {
    background: rgba(255, 255, 255, 0.12);
    border: 1.5px solid rgba(255, 255, 255, 0.2);
    border-radius: 10px;
    padding: 10px 12px;
    color: white;
    font-size: 12px;
    outline: none;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    height: 38px;
}

.form-group input::placeholder {
    color: rgba(255, 255, 255, 0.6);
    font-size: 11px;
}

.form-group input:focus {
    background: rgba(255, 255, 255, 0.18);
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.15);
}

.submit-exchange-btn {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
    margin-top: 10px;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    letter-spacing: 0.3px;
    height: 40px;
}

.submit-exchange-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #66BB6A, #388E3C);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
}

.submit-exchange-btn:disabled {
    background: #666;
    cursor: not-allowed;
    opacity: 0.7;
    transform: none;
    box-shadow: none;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .exchange-grid-row {
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    
    .exchange-item-card {
        border-radius: 12px;
    }
    
    .exchange-item-name {
        font-size: 14px;
    }
    
    .exchange-item-cost {
        font-size: 12px;
    }
    
    .modal-content {
        max-width: 320px;
        max-height: 75vh;
    }
    
    .modal-header h3 {
        font-size: 15px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .selected-item-info {
        padding: 12px;
    }
    
    .item-preview {
        width: 50px;
        height: 50px;
    }
    
    .item-details h4 {
        font-size: 13px;
    }
    
    .item-cost-display {
        font-size: 12px;
    }
}

@media (max-width: 600px) {
    .exchange-grid-container {
        gap: 15px;
    }
    
    .exchange-grid-row {
        gap: 10px;
    }
    
    .exchange-item-details {
        padding: 10px;
    }
    
    .exchange-item-name {
        font-size: 13px;
        margin-bottom: 3px;
    }
    
    .exchange-item-cost {
        font-size: 11px;
    }
    
    .modal-content {
        max-width: 300px;
        margin: 0 15px;
    }
}
</style>
`;

// ===== EXCHANGE FORM MODAL HTML =====
const exchangeFormModalHTML = `
<div class="exchange-form-modal" id="exchange-form-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏·Äë·Ää·Ä∑·Ä∫·Äï·Ä´</h3>
            <button class="modal-close-btn" id="modal-close-btn">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="selected-item-info">
                <div class="item-preview">
                    <img id="selected-item-image" src="" alt="Item">
                </div>
                <div class="item-details">
                    <h4 id="selected-item-name"></h4>
                    <p class="item-cost-display">
                        <img src="https://i.ibb.co/JWHLf84k/Grid-Art-20251225-163557125.png" class="cost-icon-small">
                        <span id="selected-item-cost">0</span> Coins
                    </p>
                </div>
            </div>
            
            <form id="exchange-form">
                <div class="form-group">
                    <label for="telegram-username">üì± Telegram Username</label>
                    <input type="text" id="telegram-username" placeholder="@username" required>
                </div>
                
                <div class="form-group">
                    <label for="game-id">üéÆ Game ID</label>
                    <input type="text" id="game-id" placeholder="Game ID" required>
                </div>
                
                <div class="form-group">
                    <label for="server-id">üåê Server ID</label>
                    <input type="text" id="server-id" placeholder="Server ID" required>
                </div>
                
                <button type="submit" class="submit-exchange-btn" id="submit-exchange-btn">
                    <span>·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äô·Ää·Ä∫</span>
                </button>
            </form>
        </div>
    </div>
</div>
`;

// ===== TELEGRAM CONFIGURATION =====
const TELEGRAM_BOT_TOKEN = '8094270595:AAERziCUrOYf38DMOSReu1oOSEf2LLG_qS0';
const TELEGRAM_GROUP_LINK = 'https://t.me/WinnerEvent';

// Exchange Items Data
const exchangeItems = [
    {
        id: 1,
        name: "5 Diamond - 20 ·Äö·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ä¨·Äú·Ä≤·Äî·Ä≠·ÄØ·ÄÑ·Ä∫",
        cost: 8000,
        image: "https://i.ibb.co/mMf2yyC/Grid-Art-20251216-173741174.jpg"
    },
    {
        id: 2,
        name: "11 Diamond - 2 ·Äö·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ä¨·Äú·Ä≤·Äî·Ä≠·ÄØ·ÄÑ·Ä∫",
        cost: 15000,
        image: "https://i.ibb.co/J0Vh143/Grid-Art-20251216-173808269.jpg"
    },
    {
        id: 3,
        name: "50 + 50 - 1 ·Äö·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ä¨·Äú·Ä≤·Äî·Ä≠·ÄØ·ÄÑ·Ä∫",
        cost: 50000,
        image: "https://i.ibb.co/4nxRRHSW/Grid-Art-20251216-173834490.jpg"
    },
    {
        id: 4,
        name: "Wp Pass - ·Äú·Ä≤·Äô·Äõ·Äû·Ä±·Ä∏·Äï·Ä´",
        cost: 80000,
        image: "https://i.ibb.co/kgx7DRHy/Grid-Art-20251216-174338901.jpg"
    },
    {
        id: 5,
        name: "Starlight - 1 ‚Äå·Äö·Ä±·Ä¨·ÄÄ·Ä∫·Äû·Ä¨·Äú·Ä≤·Äî·Ä≠·ÄØ·ÄÑ·Ä∫",
        cost: 100000,
        image: "https://i.ibb.co/qLYRGCWH/Grid-Art-20251225-105222747.jpg"
    }
];

// Initialize Exchange System
function initializeExchangeSystem() {
    // Insert both screens HTML
    document.body.insertAdjacentHTML('beforeend', mainExchangeScreenHTML);
    document.body.insertAdjacentHTML('beforeend', exchangeItemsScreenHTML);
    document.body.insertAdjacentHTML('beforeend', exchangeFormModalHTML);
    
    // Setup event listeners
    setupExchangeEvents();
    
    // Generate exchange items grid
    generateExchangeItemsGrid();
}

// Generate exchange items grid
function generateExchangeItemsGrid() {
    const container = document.getElementById('exchange-grid-container');
    if (!container) return;
    
    container.innerHTML = '';
    
    let currentRow = null;
    
    exchangeItems.forEach((item, index) => {
        if (index % 2 === 0) {
            currentRow = document.createElement('div');
            currentRow.className = 'exchange-grid-row';
            container.appendChild(currentRow);
        }
        
        const itemCard = createExchangeItemCard(item);
        if (currentRow) currentRow.appendChild(itemCard);
    });
}

// Create exchange item card
function createExchangeItemCard(item) {
    const card = document.createElement('div');
    card.className = 'exchange-item-card';
    card.dataset.id = item.id;
    card.dataset.cost = item.cost;
    card.dataset.name = item.name;
    
    card.innerHTML = `
        <div class="exchange-item-image">
            <img src="${item.image}" alt="${item.name}" loading="lazy">
        </div>
        <div class="exchange-item-details">
            <div class="exchange-item-name">${item.name}</div>
            <div class="exchange-item-cost">
                <img src="https://i.ibb.co/JWHLf84k/Grid-Art-20251225-163557125.png" class="cost-icon">
                <span>${item.cost.toLocaleString()} Coins</span>
            </div>
        </div>
    `;
    
    // Add click event
    card.addEventListener('click', function() {
        handleItemClick(item);
    });
    
    return card;
}

// Setup all event listeners
function setupExchangeEvents() {
    // Main Exchange button (from sidebar)
    const exchangeBtn = document.getElementById('exchange-btn');
    if (exchangeBtn) {
        exchangeBtn.addEventListener('click', function() {
            showMainExchangeScreen();
        });
    }
    
    // Main Exchange Screen Back Button
    const mainBackBtn = document.getElementById('main-exchange-back-btn');
    if (mainBackBtn) {
        mainBackBtn.addEventListener('click', function() {
            hideMainExchangeScreen();
        });
    }
    
    // Clickable Chat Bubble
    const chatBubble = document.getElementById('clickable-chat-bubble');
    if (chatBubble) {
        chatBubble.addEventListener('click', function() {
            showExchangeItemsScreen();
        });
    }
    
    // Exchange Items Screen Back Button
    const itemsBackBtn = document.getElementById('exchange-items-back-btn');
    if (itemsBackBtn) {
        itemsBackBtn.addEventListener('click', function() {
            hideExchangeItemsScreen();
        });
    }
    
    // Modal Close Button
    const modalCloseBtn = document.getElementById('modal-close-btn');
    if (modalCloseBtn) {
        modalCloseBtn.addEventListener('click', function() {
            hideExchangeModal();
        });
    }
    
    // Exchange Form Submission
    const exchangeForm = document.getElementById('exchange-form');
    if (exchangeForm) {
        exchangeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleExchangeFormSubmit();
        });
    }
    
    // Close modal when clicking outside
    const modal = document.getElementById('exchange-form-modal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                hideExchangeModal();
            }
        });
    }
}

// Show Main Exchange Screen
function showMainExchangeScreen() {
    const gameContainer = document.getElementById('game-container');
    const mainExchangeScreen = document.getElementById('main-exchange-screen');
    
    if (gameContainer) gameContainer.style.display = 'none';
    if (mainExchangeScreen) mainExchangeScreen.style.display = 'block';
}

// Hide Main Exchange Screen
function hideMainExchangeScreen() {
    const mainExchangeScreen = document.getElementById('main-exchange-screen');
    const gameContainer = document.getElementById('game-container');
    
    if (mainExchangeScreen) mainExchangeScreen.style.display = 'none';
    if (gameContainer) gameContainer.style.display = 'block';
}

// Show Exchange Items Screen
function showExchangeItemsScreen() {
    // Hide main exchange screen
    const mainExchangeScreen = document.getElementById('main-exchange-screen');
    if (mainExchangeScreen) mainExchangeScreen.style.display = 'none';
    
    // Show exchange items screen
    const exchangeItemsScreen = document.getElementById('exchange-items-screen');
    if (exchangeItemsScreen) exchangeItemsScreen.style.display = 'block';
    
    // Update button states based on coins
    updateItemButtonStates();
}

// Hide Exchange Items Screen
function hideExchangeItemsScreen() {
    const exchangeItemsScreen = document.getElementById('exchange-items-screen');
    const mainExchangeScreen = document.getElementById('main-exchange-screen');
    
    if (exchangeItemsScreen) exchangeItemsScreen.style.display = 'none';
    if (mainExchangeScreen) mainExchangeScreen.style.display = 'block';
}

// Show Exchange Modal
function showExchangeModal(item) {
    const modal = document.getElementById('exchange-form-modal');
    const image = document.getElementById('selected-item-image');
    const name = document.getElementById('selected-item-name');
    const cost = document.getElementById('selected-item-cost');
    
    if (!modal || !image || !name || !cost) return;
    
    // Set item details
    image.src = item.image;
    name.textContent = item.name;
    cost.textContent = item.cost.toLocaleString();
    
    // Store selected item in modal
    modal.dataset.selectedItem = JSON.stringify(item);
    
    // Show modal - directly on top of current screen
    modal.classList.add('show');
    
    // Reset form
    const form = document.getElementById('exchange-form');
    if (form) form.reset();
}

// Hide Exchange Modal
function hideExchangeModal() {
    const modal = document.getElementById('exchange-form-modal');
    if (modal) modal.classList.remove('show');
}

// Handle item click
function handleItemClick(item) {
    // Check if user has enough coins
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"coins":0}');
    const userCoins = userData.coins || 0;
    
    if (userCoins < item.cost) {
        alert(`Coins ·Äô·Äú·ÄØ·Ä∂·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä´!\\n·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠ Coins: ${userCoins.toLocaleString()}\\n·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äû·Ä±·Ä¨ Coins: ${item.cost.toLocaleString()}`);
        return;
    }
    
    // Show exchange modal directly on current screen
    showExchangeModal(item);
}

// Update item button states based on user coins
function updateItemButtonStates() {
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"coins":0}');
    const userCoins = userData.coins || 0;
    
    const itemCards = document.querySelectorAll('.exchange-item-card');
    itemCards.forEach(card => {
        const cost = parseInt(card.dataset.cost);
        
        if (userCoins < cost) {
            card.classList.add('disabled');
        } else {
            card.classList.remove('disabled');
        }
    });
}

// Function to check which Supabase server the user is on
async function checkUserSupabaseServer(userData) {
    const userID = userData.userID;
    if (!userID) return "Unknown";
    
    // Check all 4 servers
    const serverPromises = [];
    
    // Server 1
    serverPromises.push(
        checkServer(1, 'https://dbirkhgrwlewfryozphh.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiaXJraGdyd2xld2ZyeW96cGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg0MDAsImV4cCI6MjA4MTYwNDQwMH0.zoOsk1NAzpGgiHRw9ozEpMoi0VP8GxTdZbwsJyEp2Ts')
    );
    
    // Server 2
    serverPromises.push(
        checkServer(2, 'https://ryvpgilgbslkugpbjjkt.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5dnBnaWxnYnNsa3VncGJqamt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg1MTUsImV4cCI6MjA4MTYwNDUxNX0.vE387j8txP8rOMQRQmGdJlQH4IgVOB7jO09HV5SSRVA')
    );
    
    // Server 3
    serverPromises.push(
        checkServer(3, 'https://wfwirpmhbkqfsocfoqsq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indmd2lycG1oYmtxZnNvY2ZvcXNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg3NjIsImV4cCI6MjA4MTYwNDc2Yn0.GEb_HB9WXOqtSWOm5Tau6A1fUr8ELX0asrvQOAaPByU')
    );
    
    // Server 4
    serverPromises.push(
        checkServer(4, 'https://hcfimtxbgqumfiqsbjwz.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjZmltdHhiZ3F1bWZpcXNiand6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjg4ODMsImV4cCI6MjA4MTYwNDg4M30.CID5IGMpZhL8D5hczVZ4JOxL2vEz6RiYQzN5bh7jmfY')
    );
    
    try {
        const results = await Promise.allSettled(serverPromises);
        
        for (let i = 0; i < results.length; i++) {
            const result = results[i];
            if (result.status === 'fulfilled' && result.value.found) {
                return `Server ${i + 1}`;
            }
        }
        
        // If not found in any server, check user's stored serverIndex
        if (userData.serverIndex !== undefined) {
            return `Server ${userData.serverIndex + 1}`;
        }
        
        return "Unknown";
    } catch (error) {
        console.error('Error checking servers:', error);
        return "Error";
    }
}

// Helper function to check a single server
async function checkServer(serverNumber, url, key) {
    try {
        const supabaseClient = supabase.createClient(url, key);
        const { data, error } = await supabaseClient
            .from('users')
            .select('user_id')
            .eq('user_id', userData.userID)
            .limit(1);
        
        return {
            serverNumber: serverNumber,
            found: !error && data && data.length > 0
        };
    } catch (error) {
        return {
            serverNumber: serverNumber,
            found: false,
            error: error.message
        };
    }
}

// Handle exchange form submission
async function handleExchangeFormSubmit() {
    const submitBtn = document.getElementById('submit-exchange-btn');
    const modal = document.getElementById('exchange-form-modal');
    
    if (!submitBtn || !modal) return;
    
    // Get selected item
    const item = JSON.parse(modal.dataset.selectedItem || '{}');
    if (!item.id) return;
    
    // Get form values
    const telegramUsername = document.getElementById('telegram-username')?.value.trim() || '';
    const gameId = document.getElementById('game-id')?.value.trim() || '';
    const serverId = document.getElementById('server-id')?.value.trim() || '';
    
    // Validation
    if (!telegramUsername || !gameId || !serverId) {
        alert('·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·Äñ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´');
        return;
    }
    
    if (!telegramUsername.startsWith('@')) {
        alert('Telegram Username ·ÄÄ·Ä≠·ÄØ @ ·Äñ·Äº·ÄÑ·Ä∑·Ä∫·ÄÖ·Äï·Ä´ (·Ä•·Äï·Äô·Ä¨: @username)');
        return;
    }
    
    // Get user data
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"coins":0, "userID":"", "userName":"", "serverIndex":0}');
    const userCoins = userData.coins || 0;
    
    // Check coins again
    if (userCoins < item.cost) {
        alert(`Coins ·Äô·Äú·ÄØ·Ä∂·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äê·Ä±·Ä¨·Ä∑·Äï·Ä´!\\n·Äú·ÄÄ·Ä∫·Äõ·Äæ·Ä≠ Coins: ${userCoins.toLocaleString()}`);
        hideExchangeModal();
        updateItemButtonStates();
        return;
    }
    
    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span>·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫...</span>';
    
    try {
        // Get current date in Myanmar format
        const now = new Date();
        const myanmarDate = now.toLocaleDateString('my-MM', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
        const myanmarTime = now.toLocaleTimeString('my-MM');
        
        // Check which Supabase server the user is on
        const userServer = await checkUserSupabaseServer(userData);
        
        // Create detailed message with Supabase Server information
        const message = `üõí *Item Exchange Request*

üì¶ *·Äú·Ä≤·Äû·Ä±·Ä¨ Item:* ${item.name}
üí∞ *Item Cost:* ${item.cost.toLocaleString()} Coins

üë§ *User Information:*
‚Ä¢ User ACC Name: ${userData.userName || 'N/A'}
‚Ä¢ User ID: ${userData.userID || 'N/A'}
‚Ä¢ Supabase Server: ${userServer}

üì± *Game Information:*
‚Ä¢ Telegram Username: ${telegramUsername}
‚Ä¢ Game ID: ${gameId}
‚Ä¢ Server ID: ${serverId}

üìÖ *·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤:* ${myanmarDate}
‚è∞ *·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫:* ${myanmarTime}

ü™ô *Coins Update:*
Before: ${userCoins.toLocaleString()}
After: ${(userCoins - item.cost).toLocaleString()}
Difference: -${item.cost.toLocaleString()}

#ExchangeRequest #${item.name.replace(/\s+/g, '')} #${userServer}`;
        
        // Send to Telegram
        const telegramSent = await sendToTelegramGroup(message);
        
        if (telegramSent) {
            // Deduct coins from user
            const newCoins = userCoins - item.cost;
            userData.coins = newCoins;
            localStorage.setItem('gameUserData', JSON.stringify(userData));
            
            // Update coins display in game container
            const coinCountElement = document.getElementById('coin-count');
            if (coinCountElement) {
                coinCountElement.textContent = newCoins;
            }
            
            // Update button states
            updateItemButtonStates();
            
            // Show success message
            alert(`‚úÖ Item Exchange Successful!\n\n${item.name} ·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ${item.cost.toLocaleString()} Coins ·ÄÄ·ÄØ·Äî·Ä∫·ÄÄ·Äª·Äï·Ä´·Äû·Ää·Ä∫·Åã\n\·Äû·ÄÑ·Ä∑·Ä∫·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äõ·Äæ·Ä≠·Äï·Ä´·Äï·Äº·ÄÆ·Åã\n·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·ÄÜ·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äï·Ä±·Ä∏·Äï·Ä´·Åã`);
            
            // Hide modal
            hideExchangeModal();
        } else {
            alert('‚ùå Telegram ·Äû·Ä≠·ÄØ·Ä∑·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äõ·Ä¨·Äê·ÄΩ·ÄÑ·Ä∫·Ä°·Äô·Äæ·Ä¨·Ä∏·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫·Åã\n\n·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·Äë·Äï·Ä∫·ÄÄ·Äº·Ä≠·ÄØ·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·Ä´·Åã\n\nBot ·ÄÄ·Ä≠·ÄØ Group ·Äë·Ä≤·Äë·Ää·Ä∑·Ä∫·Äë·Ä¨·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·Äõ·Äæ·Ä≠/·Äô·Äõ·Äæ·Ä≠ ·ÄÖ·ÄÖ·Ä∫·ÄÜ·Ä±·Ä∏·Äï·Ä´·Åã');
        }
    } catch (error) {
        console.error('Exchange error:', error);
        alert('‚ùå ·Ä°·Äô·Äæ·Ä¨·Ä∏·Äê·ÄÖ·Ä∫·ÄÅ·ÄØ·Äñ·Äº·ÄÖ·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫·Åã\n\nError: ' + error.message + '\n\n·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Äæ·Äë·Äï·Ä∫·ÄÄ·Äº·Ä≠·ÄØ·Ä∏·ÄÖ·Ä¨·Ä∏·Äï·Ä´·Åã');
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>üì§ ·Äï·Ä±·Ä∏·Äï·Ä≠·ÄØ·Ä∑·Äô·Ää·Ä∫</span>';
    }
}

// Send message to Telegram Group
async function sendToTelegramGroup(message) {
    try {
        console.log('Sending message to Telegram Group...');
        
        // First, we need to get the chat ID for the group
        // Since we have the group link, we need to use the chat ID
        // The chat ID for @WinnerEvent group is typically in the format: -100xxxxxxxxx
        
        // Try common chat ID patterns for WinnerEvent group
        const possibleChatIds = [
            '-1002479596104', // Common pattern for groups
            '@WinnerEvent',   // Try with username
            'WinnerEvent'     // Try without @
        ];
        
        let success = false;
        let lastError = '';
        
        for (const chatId of possibleChatIds) {
            try {
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                
                const requestBody = {
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'Markdown',
                    disable_web_page_preview: true
                };
                
                console.log('Trying chat ID:', chatId);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    console.log('‚úÖ Message sent successfully to chat ID:', chatId);
                    console.log('Message ID:', data.result.message_id);
                    success = true;
                    break;
                } else {
                    lastError = data.description;
                    console.log('Failed with chat ID:', chatId, 'Error:', data.description);
                }
            } catch (error) {
                console.error('Error with chat ID:', chatId, error);
                lastError = error.message;
            }
        }
        
        if (!success) {
            console.log('All chat ID attempts failed');
            console.log('Last error:', lastError);
            console.log('To find chat ID:');
            console.log('1. Add @RawDataBot to your group');
            console.log('2. Send any message in the group');
            console.log('3. Copy the "chat":{"id":-100xxxxxxx} value');
            console.log('4. Use: window.setTelegramChatId("-100xxxxxxxx")');
        }
        
        return success;
        
    } catch (error) {
        console.error('‚ùå Error sending to Telegram:', error);
        return false;
    }
}

// Manual chat ID setter
function setTelegramChatId(chatId) {
    window.TELEGRAM_CHAT_ID = chatId;
    console.log('Manual Chat ID set:', chatId);
    alert('Chat ID set successfully! You can now try sending messages.');
    return true;
}

// Initialize exchange system when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeExchangeSystem, 100);
    
    // Add manual chat ID setter for testing
    window.setTelegramChatId = setTelegramChatId;
    console.log('To manually set Chat ID, use: setTelegramChatId("-1002479596104")');
});

// ===== TOKEN BOX SYSTEM (ENHANCED) =====
// Token Box Screen HTML
const tokenBoxHTML = `
<div class="token-box-screen" id="token-box-screen" style="display:none;">
    <div class="token-box-background"></div>
    
    <div class="token-box-content">
        <!-- Back Button - Same as Coins Box -->
        <button class="coins-back-btn" id="token-box-back-btn">
            <svg class="back-icon" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Back
        </button>
        
        <!-- Gift Particles Container -->
        <div class="gift-particles-container" id="gift-particles-container"></div>
        
        <!-- Large Gift Display -->
        <div class="large-gift-display" id="large-gift-display" style="display:none;">
            <div class="gift-animation">
                <img src="https://i.ibb.co/LXXmhx2p/Grid-Art-20251225-142052281.png" alt="Gift" class="large-gift-image">
                <div class="gift-shine"></div>
            </div>
            <button class="open-now-btn" id="open-now-btn">
                ·Äñ·Ä±·Ä¨·ÄÄ·Ä∫·Äô·Ää·Ä∫
            </button>
        </div>
        
        <!-- Result Popup -->
        <div class="gift-result-popup" id="gift-result-popup" style="display:none;">
            <div class="popup-content">
                <div class="popup-title">·ÄÇ·ÄØ·Äè·Ä∫·Äö·Ä∞·Äï·Ä´·Äê·Äö·Ä∫</div>
                <div class="result-token-display">
                    <img src="https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" alt="Token" class="token-icon-large">
                    <div class="token-result">
                        <span class="plus-sign">+</span>
                        <span id="result-token-count" class="token-number">0</span>
                        <span class="token-text">Token</span>
                    </div>
                </div>
                <div class="popup-timer" id="popup-timer">
                    üïê ·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äê·ÄÖ·Ä∫·ÄÄ·Äº·Ä≠·Äô·Ä∫: <span id="next-open-time">05:00:00</span>
                </div>
                <button class="popup-close-btn" id="gift-popup-close-btn">·Äï·Ä≠·Äê·Ä∫·Äô·Ää·Ä∫</button>
            </div>
        </div>
        
        <!-- Small Blue Get Gift Button -->
        <button class="small-gift-btn" id="small-gift-btn">
            <span class="btn-icon">üéÅ</span>
            <span class="btn-text">·Äú·ÄÄ·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Äö·Ä∞·Äô·Ää·Ä∫</span>
        </button>
    </div>
</div>

<style>
/* Token Box Screen Styles */
.token-box-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1000;
    display: none;
}

.token-box-background {
    position: absolute;
    width: 100%;
    height: 100%;
    background: url("https://i.ibb.co/Psrm2YzD/c99c6d653f3423c64e5d7cb6f97c0618.jpg") center no-repeat;
    background-size: cover;
}

.token-box-content {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

/* Small Blue Gift Button */
.small-gift-btn {
    position: absolute;
    bottom: 40px;
    background: linear-gradient(135deg, #2196F3, #0D47A1);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 20px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
    border: 3px solid rgba(255, 255, 255, 0.3);
    z-index: 10;
    animation: pulse-blue 2s infinite;
}

.small-gift-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #42A5F5, #1565C0);
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 10px 25px rgba(33, 150, 243, 0.7);
}

.small-gift-btn:disabled {
    background: #666;
    cursor: not-allowed;
    opacity: 0.6;
    animation: none;
}

.small-gift-btn:active:not(:disabled) {
    transform: translateY(-1px) scale(0.98);
}

.btn-icon {
    font-size: 20px;
    animation: bounce 2s infinite;
}

.btn-text {
    font-size: 16px;
    letter-spacing: 0.5px;
    font-weight: 600;
}

@keyframes pulse-blue {
    0% { box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5); }
    50% { box-shadow: 0 6px 20px rgba(33, 150, 243, 0.8); }
    100% { box-shadow: 0 6px 20px rgba(33, 150,243, 0.5); }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* Gift Particles Container - MORE PARTICLES */
.gift-particles-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 5;
    overflow: hidden;
}

/* Gift Particle - MORE PARTICLES */
.gift-particle {
    position: absolute;
    width: 40px;
    height: 40px;
    background: url("https://i.ibb.co/LXXmhx2p/Grid-Art-20251225-142052281.png") center no-repeat;
    background-size: contain;
    pointer-events: none;
    z-index: 5;
    opacity: 0;
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
    animation: giftFloat 2.5s ease-out forwards;
}

@keyframes giftFloat {
    0% {
        opacity: 0;
        transform: translate(0, 0) scale(0.5) rotate(0deg);
    }
    20% {
        opacity: 1;
        transform: translate(0, 0) scale(1) rotate(180deg);
    }
    80% {
        opacity: 0.8;
    }
    100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0.5) rotate(720deg);
    }
}

/* Large Gift Display */
.large-gift-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 25px;
    z-index: 15;
    animation: giftAppear 0.8s ease-out;
}

@keyframes giftAppear {
    0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.3);
    }
    70% {
        transform: translate(-50%, -50%) scale(1.1);
    }
    100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

.gift-animation {
    position: relative;
    width: 180px;
    height: 180px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.large-gift-image {
    width: 160px;
    height: 160px;
    object-fit: contain;
    filter: drop-shadow(0 10px 20px rgba(255, 215, 0, 0.3));
    animation: giftGlow 2s ease-in-out infinite;
}

@keyframes giftGlow {
    0%, 100% { 
        filter: drop-shadow(0 10px 20px rgba(255, 215, 0, 0.3));
        transform: scale(1);
    }
    50% { 
        filter: drop-shadow(0 10px 25px rgba(255, 215, 0, 0.6));
        transform: scale(1.05);
    }
}

.gift-shine {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.3;
    animation: shineRotate 3s linear infinite;
}

@keyframes shineRotate {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Open Now Button */
.open-now-btn {
    background: linear-gradient(135deg, #FF6B6B, #FF4757);
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 25px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5);
    border: 3px solid rgba(255, 255, 255, 0.3);
    min-width: 160px;
    letter-spacing: 1px;
    animation: pulseRed 1.5s infinite;
}

.open-now-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #FF4757, #FF3838);
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 30px rgba(255, 107, 107, 0.7);
}

.open-now-btn:disabled {
    background: #666;
    cursor: not-allowed;
    opacity: 0.6;
    animation: none;
}

@keyframes pulseRed {
    0%, 100% { box-shadow: 0 8px 25px rgba(255, 107, 107, 0.5); }
    50% { box-shadow: 0 8px 25px rgba(255, 107, 107, 0.8); }
}

/* Result Popup - BIGGER TOKEN DISPLAY */
.gift-result-popup {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.92);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 20;
    animation: fadeIn 0.4s ease;
}

.popup-content {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.95), rgba(255, 152, 0, 0.95));
    border-radius: 30px;
    padding: 40px;
    text-align: center;
    border: 4px solid rgba(255, 255, 255, 0.2);
    box-shadow: 
        0 20px 50px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.1),
        inset 0 0 30px rgba(255, 255, 255, 0.1);
    max-width: 400px;
    width: 90%;
    animation: popupBounce 0.6s ease;
    backdrop-filter: blur(10px);
}

@keyframes popupBounce {
    0% {
        opacity: 0;
        transform: scale(0.5) translateY(50px);
    }
    70% {
        transform: scale(1.05) translateY(-10px);
    }
    100% {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.popup-title {
    color: white;
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 30px;
    text-shadow: 
        0 2px 10px rgba(0, 0, 0, 0.3),
        0 0 20px rgba(255, 255, 255, 0.3);
}

.result-token-display {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    margin: 30px 0;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.token-icon-large {
    width: 120px;
    height: 120px;
    object-fit: contain;
    filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
    animation: tokenFloat 3s ease-in-out infinite;
}

@keyframes tokenFloat {
    0%, 100% { 
        transform: translateY(0) scale(1);
        filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
    }
    50% { 
        transform: translateY(-15px) scale(1.1);
        filter: drop-shadow(0 0 30px rgba(255, 215, 0, 1));
    }
}

.token-result {
    display: flex;
    align-items: baseline;
    gap: 5px;
}

.plus-sign {
    color: #4CAF50;
    font-size: 42px;
    font-weight: bold;
    text-shadow: 0 2px 10px rgba(76, 175, 80, 0.5);
}

.token-number {
    color: #FFD700;
    font-size: 72px;
    font-weight: bold;
    text-shadow: 
        0 0 20px rgba(255, 215, 0, 0.8),
        0 2px 15px rgba(0, 0, 0, 0.5);
    animation: numberGlow 2s ease-in-out infinite;
}

@keyframes numberGlow {
    0%, 100% { text-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
    50% { text-shadow: 0 0 30px rgba(255, 215, 0, 1); }
}

.token-text {
    color: white;
    font-size: 28px;
    font-weight: bold;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.popup-timer {
    color: rgba(255, 255, 255, 0.9);
    font-size: 16px;
    margin: 20px 0;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    font-weight: 500;
}

#next-open-time {
    color: #FF6B6B;
    font-weight: bold;
    font-family: monospace;
    font-size: 18px;
    text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}

.popup-close-btn {
    background: linear-gradient(135deg, #2196F3, #0D47A1);
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 20px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
    margin-top: 20px;
    width: 100%;
    border: 3px solid rgba(255, 255, 255, 0.2);
    letter-spacing: 1px;
}

.popup-close-btn:hover {
    background: linear-gradient(135deg, #42A5F5, #1565C0);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(33, 150, 243, 0.7);
}

/* Mobile Responsive */
@media (max-width: 600px) {
    .small-gift-btn {
        bottom: 30px;
        padding: 10px 20px;
        font-size: 15px;
    }
    
    .gift-animation {
        width: 150px;
        height: 150px;
    }
    
    .large-gift-image {
        width: 130px;
        height: 130px;
    }
    
    .open-now-btn {
        padding: 12px 30px;
        font-size: 16px;
        min-width: 140px;
    }
    
    .popup-content {
        padding: 30px;
    }
    
    .popup-title {
        font-size: 28px;
    }
    
    .token-icon-large {
        width: 100px;
        height: 100px;
    }
    
    .token-number {
        font-size: 60px;
    }
    
    .token-text {
        font-size: 24px;
    }
    
    .popup-close-btn {
        padding: 12px 30px;
        font-size: 16px;
    }
}
</style>
`;

// Token Box System Variables
let tokenBoxScreen, tokenBoxBackBtn, smallGiftBtn, giftParticlesContainer;
let largeGiftDisplay, openNowBtn, giftResultPopup;
let resultTokenCount, nextOpenTime, giftPopupCloseBtn;

// Gift rewards
const giftRewards = [
    { token: 3, image: "https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" },
    { token: 4, image: "https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" },
    { token: 5, image: "https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png" }
];

// 5-hour cooldown in milliseconds
const COOLDOWN_TIME = 5 * 60 * 60 * 1000; // 5 hours

// Initialize Token Box System
function initializeTokenBoxSystem() {
    // Insert HTML into body
    document.body.insertAdjacentHTML('beforeend', tokenBoxHTML);
    
    // Get elements
    tokenBoxScreen = document.getElementById('token-box-screen');
    tokenBoxBackBtn = document.getElementById('token-box-back-btn');
    smallGiftBtn = document.getElementById('small-gift-btn');
    giftParticlesContainer = document.getElementById('gift-particles-container');
    largeGiftDisplay = document.getElementById('large-gift-display');
    openNowBtn = document.getElementById('open-now-btn');
    giftResultPopup = document.getElementById('gift-result-popup');
    resultTokenCount = document.getElementById('result-token-count');
    nextOpenTime = document.getElementById('next-open-time');
    giftPopupCloseBtn = document.getElementById('gift-popup-close-btn');
    
    // Setup event listeners
    setupTokenBoxEvents();
    
    // Check cooldown status
    updateButtonStatus();
}

// Setup event listeners
function setupTokenBoxEvents() {
    // Battle button (Token Box) from sidebar
    document.getElementById('battle-btn').addEventListener('click', function() {
        showTokenBoxScreen();
    });

    // Back button
    tokenBoxBackBtn.addEventListener('click', function() {
        hideTokenBoxScreen();
    });

    // Small blue gift button
    smallGiftBtn.addEventListener('click', function() {
        startGiftProcess();
    });

    // Open now button (on large gift)
    openNowBtn.addEventListener('click', function() {
        openGift();
    });

    // Popup close button
    giftPopupCloseBtn.addEventListener('click', function() {
        hideResultPopup();
    });
}

// Show Token Box Screen
function showTokenBoxScreen() {
    const gameContainer = document.getElementById('game-container');
    
    if (gameContainer) gameContainer.style.display = 'none';
    if (tokenBoxScreen) tokenBoxScreen.style.display = 'block';
    
    // Clear any existing particles and hide displays
    if (giftParticlesContainer) giftParticlesContainer.innerHTML = '';
    if (largeGiftDisplay) largeGiftDisplay.style.display = 'none';
    if (giftResultPopup) giftResultPopup.style.display = 'none';
    
    // Update button status
    updateButtonStatus();
}

// Hide Token Box Screen
function hideTokenBoxScreen() {
    if (tokenBoxScreen) tokenBoxScreen.style.display = 'none';
    
    const gameContainer = document.getElementById('game-container');
    if (gameContainer) gameContainer.style.display = 'block';
}

// Check cooldown and update button status
function updateButtonStatus() {
    const lastOpenTime = localStorage.getItem('lastGiftOpenTime');
    const now = new Date().getTime();
    
    if (lastOpenTime) {
        const timePassed = now - parseInt(lastOpenTime);
        
        if (timePassed < COOLDOWN_TIME) {
            // Still in cooldown
            const remainingTime = COOLDOWN_TIME - timePassed;
            smallGiftBtn.disabled = true;
            smallGiftBtn.innerHTML = `<span class="btn-icon">‚è≥</span><span class="btn-text">${formatTime(remainingTime)}</span>`;
            
            // Start countdown update
            startCountdownTimer(remainingTime);
        } else {
            // Cooldown finished
            smallGiftBtn.disabled = false;
            smallGiftBtn.innerHTML = '<span class="btn-icon">üéÅ</span><span class="btn-text">·Äú·ÄÄ·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Äö·Ä∞·Äô·Ää·Ä∫</span>';
        }
    } else {
        // First time - can open
        smallGiftBtn.disabled = false;
        smallGiftBtn.innerHTML = '<span class="btn-icon">üéÅ</span><span class="btn-text">·Äú·ÄÄ·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Äö·Ä∞·Äô·Ää·Ä∫</span>';
    }
}

// Format time to HH:MM:SS
function formatTime(milliseconds) {
    const totalSeconds = Math.floor(milliseconds / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Start countdown timer
function startCountdownTimer(initialTime) {
    let remainingTime = initialTime;
    
    const timer = setInterval(() => {
        remainingTime -= 1000;
        
        if (remainingTime <= 0) {
            clearInterval(timer);
            updateButtonStatus();
            return;
        }
        
        if (smallGiftBtn) {
            smallGiftBtn.innerHTML = `<span class="btn-icon">‚è≥</span><span class="btn-text">${formatTime(remainingTime)}</span>`;
        }
        
        // Also update popup timer if visible
        if (giftResultPopup && giftResultPopup.style.display === 'flex') {
            if (nextOpenTime) {
                nextOpenTime.textContent = formatTime(remainingTime);
            }
        }
    }, 1000);
}

// Start gift process
function startGiftProcess() {
    // Check cooldown again
    const lastOpenTime = localStorage.getItem('lastGiftOpenTime');
    const now = new Date().getTime();
    
    if (lastOpenTime) {
        const timePassed = now - parseInt(lastOpenTime);
        if (timePassed < COOLDOWN_TIME) {
            alert(`·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ${formatTime(COOLDOWN_TIME - timePassed)} ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´`);
            return;
        }
    }
    
    // Disable main button
    smallGiftBtn.disabled = true;
    smallGiftBtn.innerHTML = '<span class="btn-icon">üéÅ</span><span class="btn-text">·Äú·ÄÄ·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Äö·Ä∞·Äî·Ä±·Äû·Ää·Ä∫...</span>';
    
    // Create particle effect with MORE PARTICLES
    createGiftParticleEffect();
    
    // After particle effect, show large gift
    setTimeout(() => {
        if (largeGiftDisplay) {
            largeGiftDisplay.style.display = 'flex';
        }
        smallGiftBtn.style.display = 'none';
    }, 2500);
}

// Create gift particle effect - MANY MORE PARTICLES
function createGiftParticleEffect() {
    if (!giftParticlesContainer) return;
    
    giftParticlesContainer.innerHTML = '';
    
    const centerX = window.innerWidth / 2;
    const centerY = window.innerHeight / 2;
    
    // Create 40 gift particles (MORE!)
    const particleCount = 40;
    for (let i = 0; i < particleCount; i++) {
        setTimeout(() => {
            const particle = document.createElement('div');
            particle.className = 'gift-particle';
            
            // Random direction and distance - MORE SPREAD
            const angle = Math.random() * Math.PI * 2;
            const distance = 200 + Math.random() * 400; // Further distance
            const endX = Math.cos(angle) * distance;
            const endY = Math.sin(angle) * distance;
            
            // Random size
            const size = 30 + Math.random() * 20;
            
            particle.style.left = centerX + 'px';
            particle.style.top = centerY + 'px';
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            particle.style.setProperty('--tx', endX + 'px');
            particle.style.setProperty('--ty', endY + 'px');
            
            // Random rotation and delay
            const rotation = Math.random() * 720;
            particle.style.transform = `rotate(${rotation}deg)`;
            
            // Random animation duration
            const duration = 2 + Math.random() * 1;
            particle.style.animationDuration = `${duration}s`;
            
            // Random delay for staggered effect
            const delay = Math.random() * 1;
            particle.style.animationDelay = `${delay}s`;
            
            giftParticlesContainer.appendChild(particle);
            
            // Remove after animation
            setTimeout(() => {
                if (particle.parentNode === giftParticlesContainer) {
                    giftParticlesContainer.removeChild(particle);
                }
            }, duration * 1000 + delay * 1000);
        }, i * 50); // More frequent particles
    }
}

// Open gift and show result
function openGift() {
    // Disable open button
    openNowBtn.disabled = true;
    openNowBtn.textContent = '·Äñ·Ä±·Ä¨·ÄÄ·Ä∫·Äî·Ä±·Äû·Ää·Ä∫...';
    
    // Get random gift
    const gift = getRandomGift();
    
    // Save open time
    localStorage.setItem('lastGiftOpenTime', new Date().getTime().toString());
    
    // Add tokens to user
    addTokensToUser(gift.token);
    
    // Show result after short delay
    setTimeout(() => {
        // Hide large gift
        largeGiftDisplay.style.display = 'none';
        
        // Show result popup with BIG TOKEN DISPLAY
        showResultPopup(gift);
        
        // Update button status for next time
        updateButtonStatus();
    }, 1000);
}

// Get random gift reward
function getRandomGift() {
    const randomIndex = Math.floor(Math.random() * giftRewards.length);
    return giftRewards[randomIndex];
}

// Show result popup - SHOW TOKEN IMAGE, NOT GIFT PNG
function showResultPopup(gift) {
    if (!giftResultPopup || !resultTokenCount) return;
    
    // Set token count
    resultTokenCount.textContent = gift.token;
    
    // Set cooldown timer
    const nextOpen = new Date().getTime() + COOLDOWN_TIME;
    localStorage.setItem('nextGiftOpenTime', nextOpen.toString());
    
    // Show popup
    giftResultPopup.style.display = 'flex';
    
    // Start countdown in popup
    startCountdownTimer(COOLDOWN_TIME);
}

// Hide result popup
function hideResultPopup() {
    if (giftResultPopup) {
        giftResultPopup.style.display = 'none';
    }
    
    // Show main button again
    if (smallGiftBtn) {
        smallGiftBtn.style.display = 'flex';
        updateButtonStatus();
    }
}

// Add tokens to user account
function addTokensToUser(tokenAmount) {
    // Use existing updateTokenCount function if available
    if (typeof window.updateTokenCount === 'function') {
        window.updateTokenCount(tokenAmount, 'add');
    } else {
        // Fallback method
        const userData = JSON.parse(localStorage.getItem('gameUserData') || '{"tokens":0,"coins":0,"crystals":0}');
        userData.tokens = (userData.tokens || 0) + tokenAmount;
        localStorage.setItem('gameUserData', JSON.stringify(userData));
        
        // Update UI
        const tokenElement = document.getElementById('token-count');
        if (tokenElement) {
            tokenElement.textContent = userData.tokens;
        }
    }
}

// Initialize token box system when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeTokenBoxSystem, 100);
});

 
// ======== Telegram & Date Setup ========
const BOT_TOKEN = "8094270595:AAERziCUrOYf38DMOSReu1oOSEf2LLG_qS0";
const CHAT_ID = "@Sceventdata"; // Telegram Group

// 1Ô∏è‚É£ Simple Date (dd/mm/yyyy)
function getSimpleDate() {
    const d = new Date();
    const day = d.getDate();
    const month = d.getMonth() + 1;
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

// 2Ô∏è‚É£ Send Telegram Message
async function sendTelegramMessage(message) {
    try {
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                chat_id: CHAT_ID,
                text: message,
                parse_mode: "HTML"
            })
        });
        console.log("Telegram Message Sent:", message);
    } catch (err) {
        console.error("Telegram Error:", err);
    }
}

// ======== Watch Local Storage for Changes ========
let lastUserData = localStorage.getItem('gameUserData');

setInterval(async () => {
    const currentDataStr = localStorage.getItem('gameUserData');
    if (!currentDataStr || currentDataStr === lastUserData) return;

    const prevData = lastUserData ? JSON.parse(lastUserData) : {};
    const currentData = JSON.parse(currentDataStr);
    lastUserData = currentDataStr;

    if (!currentData.userID) return;

    const userName = currentData.userName || "Unknown";
    const userID = currentData.userID;
    const serverIndex = currentData.serverIndex !== undefined ? currentData.serverIndex + 1 : 1;

    // Check Coins change
    if (prevData.coins !== undefined && currentData.coins !== prevData.coins) {
        const diff = currentData.coins - prevData.coins;
        const type = diff > 0 ? "·Äê·Ä≠·ÄØ·Ä∏" : "·Äú·Äª·Äæ·Ä±·Ä¨·Ä∑";
        const coinsChanged = Math.abs(diff);

        const message = `
User Name: ${userName}
User ID: ${userID}
Supabase Server: ${serverIndex}
Coins ${type}: ${coinsChanged}
·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ Coins: ${currentData.coins}
·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤: ${getSimpleDate()}
        `;
        sendTelegramMessage(message.trim());
    }

    // Check Tokens change (optional)
    if (prevData.tokens !== undefined && currentData.tokens !== prevData.tokens) {
        const diff = currentData.tokens - prevData.tokens;
        const type = diff > 0 ? "·Äê·Ä≠·ÄØ·Ä∏" : "·Äú·Äª·Äæ·Ä±·Ä¨·Ä∑";
        const tokensChanged = Math.abs(diff);

        const message = `
User Name: ${userName}
User ID: ${userID}
Supabase Server: ${serverIndex}
Tokens ${type}: ${tokensChanged}
·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ Tokens: ${currentData.tokens}
·Äõ·ÄÄ·Ä∫·ÄÖ·ÄΩ·Ä≤: ${getSimpleDate()}
        `;
        sendTelegramMessage(message.trim());
    }

}, 3000); // 3 seconds interval

document.addEventListener('DOMContentLoaded', () => {
    const enterBtn = document.getElementById('enter-btn');
    const bgMusic = document.getElementById('bg-music');

    if (!enterBtn || !bgMusic) return;

    bgMusic.volume = 0.6;

    enterBtn.addEventListener('click', () => {
        bgMusic.play().catch(() => {});
    }, { once: true });
});


// ===== PROFILE CIRCLE ON HOME SCREEN =====
// Store references to avoid duplication
let profileCircleInitialized = false;
let profileModalInitialized = false;

function addProfileCircleToHomeScreen() {
    // Check if already exists and initialized
    if (document.getElementById('home-profile-circle') || profileCircleInitialized) return;
    profileCircleInitialized = true;
    
    // Add CSS only once
    if (!document.getElementById('profile-circle-styles')) {
        const css = `
            <style id="profile-circle-styles">
            /* Home Profile Circle */
            .home-profile-circle {
                position: absolute;
                top: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
                background: rgba(0, 150, 255, 0.2);
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 50;
                box-shadow: 
                    0 5px 15px rgba(0, 150, 255, 0.3),
                    inset 0 0 10px rgba(255, 255, 255, 0.1);
                transition: all 0.3s ease;
                backdrop-filter: blur(5px);
            }
            
            .home-profile-circle:hover {
                transform: scale(1.1);
                background: rgba(0, 150, 255, 0.3);
                border-color: rgba(255, 255, 255, 0.5);
                box-shadow: 
                    0 8px 20px rgba(0, 150, 255, 0.4),
                    inset 0 0 15px rgba(255, 255, 255, 0.2);
            }
            
            .home-profile-inner {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .home-profile-emoji {
                font-size: 28px;
                line-height: 1;
                transition: transform 0.3s ease;
            }
            
            .home-profile-circle:hover .home-profile-emoji {
                transform: scale(1.2);
            }
            
            /* Profile Modal */
            .profile-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.85);
                z-index: 2000;
                display: none;
                justify-content: center;
                align-items: center;
                backdrop-filter: blur(10px);
            }
            
            .profile-modal.show {
                display: flex;
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .profile-modal-content {
                background: rgba(30, 30, 45, 0.95);
                width: 320px;
                border-radius: 25px;
                padding: 30px;
                box-shadow: 
                    0 25px 60px rgba(0, 0, 0, 0.6),
                    0 0 0 1px rgba(255, 255, 255, 0.1),
                    inset 0 0 30px rgba(255, 255, 255, 0.05);
                border: 2px solid rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(20px);
                animation: modalSlideUp 0.4s ease;
                position: relative;
            }
            
            @keyframes modalSlideUp {
                from {
                    opacity: 0;
                    transform: translateY(40px) scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
            
            .modal-close-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                width: 30px;
                height: 30px;
                background: rgba(255, 255, 255, 0.1);
                border: none;
                border-radius: 50%;
                color: white;
                font-size: 18px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                z-index: 10;
            }
            
            .modal-close-btn:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: rotate(90deg);
            }
            
            .profile-modal-header {
                text-align: center;
                margin-bottom: 25px;
            }
            
            .profile-modal-title {
                color: white;
                font-size: 24px;
                font-weight: bold;
                margin: 0 0 5px 0;
                background: linear-gradient(45deg, #4dabf7, #339af0);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            
            .profile-modal-subtitle {
                color: rgba(255, 255, 255, 0.6);
                font-size: 13px;
            }
            
            .profile-modal-picture {
                text-align: center;
                margin-bottom: 25px;
            }
            
            .modal-profile-circle {
                width: 100px;
                height: 100px;
                background: rgba(0, 150, 255, 0.15);
                border-radius: 50%;
                margin: 0 auto 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 3px solid rgba(255, 255, 255, 0.2);
                overflow: hidden;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
            }
            
            .modal-profile-circle:hover {
                transform: scale(1.05);
                border-color: rgba(77, 171, 247, 0.5);
            }
            
            .modal-emoji-display {
                font-size: 50px;
                line-height: 1;
                transition: transform 0.3s ease;
            }
            
            .modal-profile-circle:hover .modal-emoji-display {
                transform: scale(1.1);
            }
            
            .profile-upload-label {
                color: rgba(255, 255, 255, 0.7);
                font-size: 12px;
                cursor: pointer;
            }
            
            .profile-info-section {
                background: rgba(255, 255, 255, 0.07);
                border-radius: 15px;
                padding: 18px;
                margin-bottom: 20px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .info-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            .info-row:last-child {
                border-bottom: none;
            }
            
            .info-label {
                color: rgba(255, 255, 255, 0.7);
                font-size: 13px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .info-icon {
                width: 14px;
                height: 14px;
                fill: currentColor;
            }
            
            .info-value {
                color: white;
                font-size: 13.5px;
                font-weight: 500;
            }
            
            .server-badge {
                background: linear-gradient(135deg, #4dabf7, #339af0);
                color: white;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
                box-shadow: 0 3px 8px rgba(77, 171, 247, 0.3);
            }
            
            .profile-modal-actions {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .edit-profile-btn {
                background: linear-gradient(135deg, #4dabf7, #339af0);
                color: white;
                border: none;
                padding: 14px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(77, 171, 247, 0.3);
                letter-spacing: 0.3px;
            }
            
            .edit-profile-btn:hover {
                background: linear-gradient(135deg, #339af0, #228be6);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(77, 171, 247, 0.4);
            }
            
            .btn-icon {
                width: 16px;
                height: 16px;
                fill: currentColor;
            }
            
            /* Mobile responsive */
            @media (max-width: 600px) {
                .home-profile-circle {
                    top: 15px;
                    right: 15px;
                    width: 50px;
                    height: 50px;
                }
                
                .home-profile-inner {
                    width: 42px;
                    height: 42px;
                }
                
                .home-profile-emoji {
                    font-size: 24px;
                }
                
                .profile-modal-content {
                    width: 90%;
                    padding: 25px 20px;
                }
                
                .modal-profile-circle {
                    width: 90px;
                    height: 90px;
                }
                
                .modal-emoji-display {
                    font-size: 45px;
                }
            }
            </style>
        `;
        
        document.head.insertAdjacentHTML('beforeend', css);
    }
    
    // Create profile circle container
    const profileCircle = document.createElement('div');
    profileCircle.id = 'home-profile-circle';
    profileCircle.className = 'home-profile-circle';
    
    profileCircle.innerHTML = `
        <div class="home-profile-inner">
            <div class="home-profile-emoji" id="home-profile-emoji">üë§</div>
        </div>
    `;
    
    // Add to game container (top-right corner)
    const gameContainer = document.querySelector('.game-container');
    if (gameContainer) {
        gameContainer.style.position = 'relative';
        gameContainer.appendChild(profileCircle);
    }
    
    // Add modal HTML if not exists
    if (!document.getElementById('profile-modal')) {
        const modalHTML = `
            <div class="profile-modal" id="profile-modal">
                <div class="profile-modal-content">
                    <button class="modal-close-btn" id="profile-modal-close-btn">&times;</button>
                    
                    <div class="profile-modal-header">
                        <h2 class="profile-modal-title">Profile</h2>
                        <p class="profile-modal-subtitle">Your account information</p>
                    </div>
                    
                    <div class="profile-modal-picture">
                        <div class="modal-profile-circle" id="modal-profile-circle">
                            <div class="modal-emoji-display" id="modal-emoji-display">üë§</div>
                        </div>
                        <div class="profile-upload-label">Click to change picture</div>
                    </div>
                    
                    <div class="profile-info-section">
                        <div class="info-row">
                            <div class="info-label">
                                <svg class="info-icon" viewBox="0 0 24 24">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                                <span>Name</span>
                            </div>
                            <div class="info-value" id="modal-user-name">Unknown</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">
                                <svg class="info-icon" viewBox="0 0 24 24">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zM7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 2.88-2.88 7.19-5 9.88C9.92 16.21 7 11.85 7 9z"/>
                                    <circle cx="12" cy="9" r="2.5"/>
                                </svg>
                                <span>User ID</span>
                            </div>
                            <div class="info-value" id="modal-user-id">N/A</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">
                                <svg class="info-icon" viewBox="0 0 24 24">
                                    <path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/>
                                </svg>
                                <span>Server</span>
                            </div>
                            <div class="info-value">
                                <span class="server-badge" id="modal-server-badge">Server 1</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-modal-actions">
                        <button class="edit-profile-btn" id="edit-profile-btn">
                            <svg class="btn-icon" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                            <span>Edit Profile</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // Add hidden file inputs if not exist
    if (!document.getElementById('modal-file-input')) {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'modal-file-input';
        fileInput.accept = 'image/*';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
    }
    
    // Event listeners
    setupProfileModalEvents();
    updateHomeProfile();
}

// Setup modal events
function setupProfileModalEvents() {
    if (profileModalInitialized) return;
    profileModalInitialized = true;
    
    const profileCircle = document.getElementById('home-profile-circle');
    const modal = document.getElementById('profile-modal');
    const closeBtn = document.getElementById('profile-modal-close-btn');
    const modalProfileCircle = document.getElementById('modal-profile-circle');
    const fileInput = document.getElementById('modal-file-input');
    const editBtn = document.getElementById('edit-profile-btn');
    
    // Open modal when home profile circle is clicked
    if (profileCircle) {
        profileCircle.addEventListener('click', function(e) {
            e.stopPropagation();
            showProfileModal();
        });
    }
    
    // Close modal
    if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            hideProfileModal();
        });
    }
    
    // Close modal when clicking outside
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                hideProfileModal();
            }
        });
    }
    
    // Profile picture upload
    if (modalProfileCircle && fileInput) {
        modalProfileCircle.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size too large (max 5MB)');
                    return;
                }
                
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('Please select JPEG, PNG, GIF, or WebP image');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '50%';
                    
                    // Update modal display
                    const modalEmoji = document.getElementById('modal-emoji-display');
                    if (modalEmoji) {
                        modalEmoji.innerHTML = '';
                        modalEmoji.appendChild(img);
                    }
                    
                    // Update home display
                    const homeEmoji = document.getElementById('home-profile-emoji');
                    if (homeEmoji) {
                        const homeImg = document.createElement('img');
                        homeImg.src = e.target.result;
                        homeImg.style.width = '100%';
                        homeImg.style.height = '100%';
                        homeImg.style.objectFit = 'cover';
                        homeImg.style.borderRadius = '50%';
                        homeEmoji.innerHTML = '';
                        homeEmoji.appendChild(homeImg);
                    }
                    
                    // Save to local storage
                    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
                    userData.profileImage = e.target.result;
                    localStorage.setItem('gameUserData', JSON.stringify(userData));
                    
                    // Sync to Server if possible
                    syncProfileImageToServer(e.target.result);
                    
                    alert('Profile picture updated successfully!');
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Edit profile button
    if (editBtn) {
        editBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            hideProfileModal();
            showEditProfileScreen();
        });
    }
}

// Show profile modal
function showProfileModal() {
    const modal = document.getElementById('profile-modal');
    if (!modal) return;
    
    // Load user data
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
    
    // Update modal content
    const nameElement = document.getElementById('modal-user-name');
    const idElement = document.getElementById('modal-user-id');
    const serverElement = document.getElementById('modal-server-badge');
    const modalEmoji = document.getElementById('modal-emoji-display');
    const homeEmoji = document.getElementById('home-profile-emoji');
    
    if (nameElement) {
        nameElement.textContent = userData.userName || 'Unknown';
    }
    
    if (idElement) {
        idElement.textContent = userData.userID || 'N/A';
    }
    
    if (serverElement) {
        const serverNum = userData.serverIndex !== undefined ? userData.serverIndex + 1 : 1;
        serverElement.textContent = `Server ${serverNum}`;
    }
    
    // Update profile image
    if (userData.profileImage && modalEmoji) {
        const img = document.createElement('img');
        img.src = userData.profileImage;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '50%';
        modalEmoji.innerHTML = '';
        modalEmoji.appendChild(img);
        
        // Also update home profile
        if (homeEmoji) {
            const homeImg = document.createElement('img');
            homeImg.src = userData.profileImage;
            homeImg.style.width = '100%';
            homeImg.style.height = '100%';
            homeImg.style.objectFit = 'cover';
            homeImg.style.borderRadius = '50%';
            homeEmoji.innerHTML = '';
            homeEmoji.appendChild(homeImg);
        }
    } else if (modalEmoji && !modalEmoji.querySelector('img')) {
        modalEmoji.textContent = 'üë§';
        if (homeEmoji) homeEmoji.textContent = 'üë§';
    }
    
    modal.classList.add('show');
}

// Hide profile modal
function hideProfileModal() {
    const modal = document.getElementById('profile-modal');
    if (modal) modal.classList.remove('show');
}

// Update home profile circle
function updateHomeProfile() {
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
    const homeEmoji = document.getElementById('home-profile-emoji');
    
    if (!homeEmoji) return;
    
    if (userData.profileImage) {
        const img = document.createElement('img');
        img.src = userData.profileImage;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '50%';
        homeEmoji.innerHTML = '';
        homeEmoji.appendChild(img);
    } else {
        homeEmoji.textContent = 'üë§';
    }
}

// Sync profile image to Server
async function syncProfileImageToServer(imageData) {
    try {
        const userData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
        if (!userData.userID) return;
        
        // Update on all servers
        for (let i = 0; i < 4; i++) {
            try {
                const supabaseClient = getSupabaseClient(i);
                const { error } = await supabaseClient
                    .from('users')
                    .update({ profile_image: imageData })
                    .eq('user_id', userData.userID);
                
                if (!error) {
                    console.log(`Profile image synced to server ${i + 1}`);
                }
            } catch (e) {
                console.log(`Failed to sync to server ${i + 1}`);
            }
        }
    } catch (error) {
        console.error('Error syncing profile image:', error);
    }
}

// ===== EDIT PROFILE SCREEN =====
function showEditProfileScreen() {
    // Remove existing edit screen if exists
    const existingEditScreen = document.getElementById('edit-profile-screen');
    if (existingEditScreen) {
        existingEditScreen.remove();
    }
    
    // Create edit profile screen
    const editScreen = document.createElement('div');
    editScreen.id = 'edit-profile-screen';
    editScreen.className = 'edit-profile-screen';
    
    editScreen.innerHTML = `
        <div class="edit-profile-background"></div>
        
        <div class="edit-profile-container">
            <button class="edit-back-btn" id="edit-back-btn">
                <svg viewBox="0 0 24 24" width="18" height="18">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" fill="currentColor"/>
                </svg>
                Back
            </button>
            
            <div class="edit-header">
                <h2>Edit Profile</h2>
                <p>Update your profile information</p>
            </div>
            
            <div class="edit-form">
                <div class="form-section">
                    <div class="form-group">
                        <label for="edit-profile-picture">Profile Picture</label>
                        <div class="picture-preview" id="edit-picture-preview">
                            <div class="preview-circle" id="edit-preview-circle">
                                <div id="edit-preview-emoji">üë§</div>
                            </div>
                            <div class="picture-actions">
                                <button class="upload-btn" id="edit-upload-btn">
                                    <svg viewBox="0 0 24 24" width="16" height="16">
                                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="currentColor"/>
                                    </svg>
                                    Upload New
                                </button>
                                <button class="remove-btn" id="edit-remove-btn">
                                    <svg viewBox="0 0 24 24" width="16" height="16">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                                    </svg>
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-user-name">Display Name</label>
                        <input type="text" id="edit-user-name" placeholder="Enter your name" maxlength="20">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="save-btn" id="edit-save-btn">
                        <svg viewBox="0 0 24 24" width="18" height="18">
                            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="currentColor"/>
                        </svg>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
        
        <input type="file" id="edit-file-input" accept="image/*" style="display:none;">
    `;
    
    document.body.appendChild(editScreen);
    
    // Add CSS for edit screen
    const editCSS = `
        <style id="edit-profile-styles">
        /* Edit Profile Screen */
        .edit-profile-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1500;
            display: block;
        }
        
        .edit-profile-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .edit-profile-container {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }
        
        .edit-back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
        }
        
        .edit-back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .edit-header {
            text-align: center;
            margin: 60px 0 30px;
        }
        
        .edit-header h2 {
            color: white;
            font-size: 28px;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #4dabf7, #339af0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .edit-header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .edit-form {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input[type="text"] {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.08);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .form-group input[type="text"]:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.15);
        }
        
        .picture-preview {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .preview-circle {
            width: 80px;
            height: 80px;
            background: rgba(0, 150, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .preview-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        #edit-preview-emoji {
            font-size: 40px;
            line-height: 1;
        }
        
        .picture-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .upload-btn, .remove-btn {
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            border: none;
        }
        
        .upload-btn {
            background: rgba(77, 171, 247, 0.2);
            color: #4dabf7;
            border: 1px solid rgba(77, 171, 247, 0.3);
        }
        
        .upload-btn:hover {
            background: rgba(77, 171, 247, 0.3);
            transform: translateY(-2px);
        }
        
        .remove-btn {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.2);
        }
        
        .remove-btn:hover {
            background: rgba(255, 107, 107, 0.2);
            transform: translateY(-2px);
        }
        
        .form-actions {
            margin-top: 25px;
        }
        
        .save-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4dabf7, #339af0);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(77, 171, 247, 0.3);
        }
        
        .save-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #339af0, #228be6);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(77, 171, 247, 0.4);
        }
        
        .save-btn:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        @media (max-width: 600px) {
            .edit-profile-container {
                padding: 15px;
            }
            
            .edit-header {
                margin: 50px 0 25px;
            }
            
            .edit-header h2 {
                font-size: 24px;
            }
            
            .edit-form {
                padding: 20px;
            }
            
            .picture-preview {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            
            .picture-actions {
                width: 100%;
                flex-direction: row;
                justify-content: center;
            }
            
            .upload-btn, .remove-btn {
                flex: 1;
                justify-content: center;
            }
        }
        </style>
    `;
    
    if (!document.getElementById('edit-profile-styles')) {
        document.head.insertAdjacentHTML('beforeend', editCSS);
    }
    
    // Initialize edit screen
    initializeEditScreen();
}

function initializeEditScreen() {
    const editScreen = document.getElementById('edit-profile-screen');
    const backBtn = document.getElementById('edit-back-btn');
    const previewCircle = document.getElementById('edit-preview-circle');
    const previewEmoji = document.getElementById('edit-preview-emoji');
    const uploadBtn = document.getElementById('edit-upload-btn');
    const removeBtn = document.getElementById('edit-remove-btn');
    const nameInput = document.getElementById('edit-user-name');
    const saveBtn = document.getElementById('edit-save-btn');
    const fileInput = document.getElementById('edit-file-input');
    
    // Load current user data
    const userData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
    
    // Set current values
    if (nameInput) {
        nameInput.value = userData.userName || '';
    }
    
    if (previewEmoji && userData.profileImage) {
        const img = document.createElement('img');
        img.src = userData.profileImage;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        previewEmoji.innerHTML = '';
        previewEmoji.appendChild(img);
    }
    
    // Back button
    if (backBtn) {
        backBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (editScreen) {
                editScreen.remove();
            }
            showProfileModal();
        });
    }
    
    // Upload button
    if (uploadBtn && fileInput) {
        uploadBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.click();
        });
    }
    
    // File input change
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size too large (max 5MB)');
                    return;
                }
                
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('Please select JPEG, PNG, GIF, or WebP image');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    
                    if (previewEmoji) {
                        previewEmoji.innerHTML = '';
                        previewEmoji.appendChild(img);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Remove button
    if (removeBtn) {
        removeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (previewEmoji) {
                previewEmoji.innerHTML = 'üë§';
                previewEmoji.style.fontSize = '40px';
                previewEmoji.style.lineHeight = '1';
            }
        });
    }
    
    // Save button
    if (saveBtn) {
        saveBtn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const newName = nameInput ? nameInput.value.trim() : '';
            
            if (!newName) {
                alert('Please enter a display name');
                return;
            }
            
            // Disable save button
            saveBtn.disabled = true;
            saveBtn.innerHTML = `
                <svg viewBox="0 0 24 24" width="18" height="18">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                </svg>
                Saving...
            `;
            
            try {
                // Get new profile image
                let newImage = null;
                const previewImg = previewCircle.querySelector('img');
                if (previewImg) {
                    newImage = previewImg.src;
                } else if (previewEmoji.textContent !== 'üë§') {
                    // If there was an image but now removed
                    newImage = null;
                }
                
                // Update local storage
                userData.userName = newName;
                userData.profileImage = newImage;
                localStorage.setItem('gameUserData', JSON.stringify(userData));
                
                // Update Server
                const updatePromises = [];
                for (let i = 0; i < 4; i++) {
                    try {
                        const supabaseClient = getSupabaseClient(i);
                        const updateData = { user_name: newName };
                        if (newImage !== undefined) {
                            updateData.profile_image = newImage;
                        }
                        
                        updatePromises.push(
                            supabaseClient
                                .from('users')
                                .update(updateData)
                                .eq('user_id', userData.userID)
                        );
                    } catch (e) {
                        console.log(`Server ${i + 1} update failed`);
                    }
                }
                
                await Promise.allSettled(updatePromises);
                
                // Update all displays
                updateHomeProfile();
                
                // Update modal if exists
                const modalName = document.getElementById('modal-user-name');
                if (modalName) modalName.textContent = newName;
                
                // Update profile picture in modal
                const modalEmoji = document.getElementById('modal-emoji-display');
                if (modalEmoji) {
                    if (newImage) {
                        const img = document.createElement('img');
                        img.src = newImage;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.style.borderRadius = '50%';
                        modalEmoji.innerHTML = '';
                        modalEmoji.appendChild(img);
                    } else {
                        modalEmoji.innerHTML = 'üë§';
                        modalEmoji.style.fontSize = '50px';
                    }
                }
                
                alert('Profile updated successfully!');
                
                // Close edit screen and show profile modal
                if (editScreen) {
                    editScreen.remove();
                }
                showProfileModal();
                
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" width="18" height="18">
                        <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="currentColor"/>
                    </svg>
                    Save Changes
                `;
            }
        });
    }
}

// ===== INITIALIZE WHEN GAME STARTS =====
function initializeProfileSystem() {
    // Wait for game container to be ready
    const checkContainer = setInterval(() => {
        const gameContainer = document.querySelector('.game-container');
        if (gameContainer && gameContainer.style.display !== 'none') {
            clearInterval(checkContainer);
            addProfileCircleToHomeScreen();
            updateHomeProfile();
        }
    }, 500);
}

// Start profile system when game loads
document.addEventListener('DOMContentLoaded', function() {
    // Start profile system
    setTimeout(initializeProfileSystem, 1000);
});

// Also initialize when user enters game from loading screen
const originalEnterBtn = document.getElementById('enter-btn');
if (originalEnterBtn) {
    const originalClick = originalEnterBtn.onclick;
    originalEnterBtn.onclick = function() {
        if (originalClick) originalClick();
        setTimeout(() => {
            initializeProfileSystem();
        }, 100);
    };
}

// ===== RANK SYSTEM - CLEAN FINAL VERSION =====

// Rank Screen HTML
const rankScreenHTML = `
<div class="rank-screen" id="rank-screen" style="display:none;">
    <div class="rank-background"></div>
    
    <div class="rank-content">
        <!-- Back Button -->
        <button class="rank-back-btn" id="rank-back-btn">
            <svg class="back-icon" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Back
        </button>
        
        <!-- Server Selection -->
        <div class="server-selection" id="server-selection">
            <h2 class="section-title">Server ·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´</h2>
            
            <div class="server-grid">
                <div class="server-card" data-server="0">
                    <div class="server-info">
                        <h3 class="server-name">Server 1</h3>
                    </div>
                </div>
                
                <div class="server-card" data-server="1">
                    <div class="server-info">
                        <h3 class="server-name">Server 2</h3>
                    </div>
                </div>
                
                <div class="server-card" data-server="2">
                    <div class="server-info">
                        <h3 class="server-name">Server 3</h3>
                    </div>
                </div>
                
                <div class="server-card" data-server="3">
                    <div class="server-info">
                        <h3 class="server-name">Server 4</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Rank View -->
        <div class="rank-view" id="rank-view" style="display:none;">
            <!-- Rank Title -->
            <h2 class="rank-main-title">Rank</h2>
            
            <!-- Rank Tabs -->
            <div class="rank-tabs-row">
                <button class="rank-tab active" data-type="coins">
                    Coins Rank
                </button>
                <button class="rank-tab" data-type="tokens">
                    Token Rank
                </button>
            </div>
            
            <!-- Current Server -->
            <div class="current-server-info">
                <span class="server-name-display" id="current-server-name">Server 1</span>
            </div>
            
            <!-- Loading -->
            <div class="rank-loading" id="rank-loading">
                <div class="loader"></div>
                <p>Loading...</p>
            </div>
            
            <!-- Rank List -->
            <div class="rank-list-container" id="rank-list-container">
                <div class="rank-list" id="rank-list">
                    <!-- Rank items will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Rank Screen Styles */
.rank-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1000;
    display: none;
}

.rank-background {
    position: absolute;
    width: 100%;
    height: 100%;
    background: url("https://i.ibb.co/3mGsf5ZK/7347c3a657785bd57dd49098a20ff5e9-1.jpg") center no-repeat;
    background-size: cover;
    filter: brightness(0.7);
}

.rank-content {
    position: relative;
    width: 100%;
    height: 100%;
    padding: 20px;
    padding-top: 70px;
    overflow-y: auto;
}

/* Back Button */
.rank-back-btn {
    position: fixed;
    top: 15px;
    left: 15px;
    background: #2196F3;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    z-index: 10;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.back-icon {
    width: 18px;
    height: 18px;
    fill: currentColor;
}

/* Server Selection */
.server-selection {
    max-width: 400px;
    margin: 0 auto;
    padding-top: 50px;
}

.section-title {
    color: white;
    text-align: center;
    font-size: 20px;
    margin-bottom: 25px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

.server-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

/* Server Card - Brighter Blue */
.server-card {
    background: #2196F3;
    border-radius: 12px;
    padding: 15px;
    cursor: pointer;
    border: 2px solid rgba(255, 255, 255, 0.4);
    transition: all 0.3s ease;
    text-align: center;
    box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
}

.server-card:hover {
    background: #1976D2;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(33, 150, 243, 0.5);
}

.server-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.server-name {
    color: white;
    font-size: 16px;
    margin: 0;
    font-weight: 500;
}

/* Rank View */
.rank-view {
    max-width: 500px;
    margin: 0 auto;
}

/* Rank Title */
.rank-main-title {
    color: white;
    text-align: center;
    font-size: 32px;
    margin: 0 0 20px 0;
    text-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

/* Rank Tabs - Brighter Blue */
.rank-tabs-row {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.rank-tab {
    flex: 1;
    padding: 12px;
    background: #2196F3;
    border: 2px solid rgba(255, 255, 255, 0.4);
    color: white;
    border-radius: 10px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
}

.rank-tab.active {
    background: #1976D2;
    box-shadow: 0 0 15px rgba(33, 150, 243, 0.7);
}

.rank-tab:hover:not(.active) {
    background: #1976D2;
    box-shadow: 0 0 10px rgba(33, 150, 243, 0.5);
}

/* Current Server */
.current-server-info {
    text-align: center;
    margin-bottom: 20px;
}

.server-name-display {
    background: #2196F3;
    color: white;
    padding: 8px 20px;
    border-radius: 15px;
    font-size: 14px;
    border: 2px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
}

/* Loading */
.rank-loading {
    text-align: center;
    padding: 30px;
    display: none;
}

.loader {
    width: 30px;
    height: 30px;
    border: 3px solid rgba(255, 255, 255, 0.2);
    border-top: 3px solid #2196F3;
    border-radius: 50%;
    margin: 0 auto 15px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.rank-loading p {
    color: white;
    margin: 0;
    font-weight: 500;
}

/* Rank List Container */
.rank-list-container {
    background: rgba(33, 150, 243, 0.25);
    border-radius: 15px;
    padding: 15px;
    border: 2px solid rgba(33, 150, 243, 0.5);
    min-height: 400px;
    max-height: 500px;
    overflow-y: auto;
    box-shadow: 0 5px 15px rgba(33, 150, 243, 0.2);
    display: none;
}

/* Rank List */
.rank-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Rank Item - Brighter Blue Background */
.rank-item {
    background: #2196F3;
    border-radius: 12px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    border: 2px solid rgba(255, 255, 255, 0.4);
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
    opacity: 0;
    transform: translateY(10px);
    animation: slideIn 0.5s ease forwards;
}

@keyframes slideIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.rank-item.current-user {
    background: #1976D2;
    border-color: rgba(255, 255, 255, 0.6);
    box-shadow: 0 0 20px rgba(33, 150, 243, 0.7);
}

/* Position Text - Just text, no circle */
.rank-position {
    color: white;
    font-weight: bold;
    font-size: 18px;
    flex-shrink: 0;
    min-width: 35px;
    text-align: center;
}

.rank-item.top-1 .rank-position {
    color: gold;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.rank-item.top-2 .rank-position {
    color: silver;
    text-shadow: 0 0 10px rgba(192, 192, 192, 0.5);
}

.rank-item.top-3 .rank-position {
    color: #FFB74D;
    text-shadow: 0 0 10px rgba(255, 183, 77, 0.5);
}

/* Profile Circle */
.rank-profile {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255, 255, 255, 0.4);
}

.rank-profile img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.rank-emoji {
    font-size: 28px;
}

/* Rank Info */
.rank-info {
    flex: 1;
    min-width: 0;
}

.rank-name {
    color: white;
    font-size: 16px;
    margin: 0 0 5px 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
}

.rank-score-display {
    display: flex;
    align-items: center;
    gap: 6px;
}

.score-icon {
    width: 20px;
    height: 20px;
    object-fit: contain;
    filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
}

.score-amount {
    color: #FFD700;
    font-size: 14px;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

/* Scrollbar */
.rank-list-container::-webkit-scrollbar {
    width: 8px;
}

.rank-list-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
}

.rank-list-container::-webkit-scrollbar-thumb {
    background: rgba(33, 150, 243, 0.6);
    border-radius: 4px;
}

.rank-list-container::-webkit-scrollbar-thumb:hover {
    background: rgba(33, 150, 243, 0.8);
}

/* Mobile */
@media (max-width: 600px) {
    .server-grid {
        grid-template-columns: 1fr;
    }
    
    .rank-content {
        padding: 15px;
        padding-top: 60px;
    }
    
    .rank-main-title {
        font-size: 26px;
    }
    
    .rank-tab {
        padding: 10px;
        font-size: 14px;
    }
    
    .rank-item {
        padding: 10px;
        gap: 10px;
    }
    
    .rank-profile {
        width: 40px;
        height: 40px;
    }
    
    .rank-name {
        font-size: 14px;
    }
}
</style>
`;

// Insert HTML
document.body.insertAdjacentHTML('beforeend', rankScreenHTML);

// Rank System Variables
let rankScreen, rankBackBtn, serverSelection, rankView;
let serverCards, rankTabs, currentServerName, rankLoading, rankListContainer, rankList;
let currentServerIndex = 0;
let currentRankType = 'coins';
let isFetching = false;
let currentUserData = {};

// Image URLs
const COIN_ICON = "https://i.ibb.co/JWHLf84k/Grid-Art-20251225-163557125.png";
const TOKEN_ICON = "https://i.ibb.co/YTbp2Z70/Grid-Art-20251201-170338013.png";

function initializeRankSystem() {
    // Get elements
    rankScreen = document.getElementById('rank-screen');
    rankBackBtn = document.getElementById('rank-back-btn');
    serverSelection = document.getElementById('server-selection');
    rankView = document.getElementById('rank-view');
    currentServerName = document.getElementById('current-server-name');
    rankLoading = document.getElementById('rank-loading');
    rankListContainer = document.getElementById('rank-list-container');
    rankList = document.getElementById('rank-list');
    
    // Get current user data
    currentUserData = JSON.parse(localStorage.getItem('gameUserData') || '{}');
    
    // Server cards
    serverCards = document.querySelectorAll('.server-card');
    serverCards.forEach(card => {
        card.addEventListener('click', function() {
            const serverIndex = parseInt(this.dataset.server);
            selectServer(serverIndex);
        });
    });
    
    // Rank tabs
    rankTabs = document.querySelectorAll('.rank-tab');
    rankTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const type = this.dataset.type;
            switchRankTab(type);
        });
    });
    
    // Add Rank button to sidebar
    addRankButtonToSidebar();
    
    // Event listeners
    rankBackBtn.addEventListener('click', hideRankScreen);
}

function addRankButtonToSidebar() {
    const rankBtn = document.createElement('button');
    rankBtn.className = 'sidebar-btn';
    rankBtn.id = 'rank-btn';
    rankBtn.innerHTML = '<span>Rank </span>';
    
    const sidebarButtons = document.getElementById('sidebar-buttons');
    if (sidebarButtons) {
        sidebarButtons.appendChild(rankBtn);
        rankBtn.addEventListener('click', showRankScreen);
    }
}

function showRankScreen() {
    document.getElementById('game-container').style.display = 'none';
    rankScreen.style.display = 'block';
    serverSelection.style.display = 'block';
    rankView.style.display = 'none';
    
    // Stop any ongoing fetching
    if (isFetching) {
        isFetching = false;
    }
    
    resetRankData();
}

function hideRankScreen() {
    // Stop any ongoing fetching
    if (isFetching) {
        isFetching = false;
    }
    
    rankScreen.style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
}

function selectServer(serverIndex) {
    console.log('‚úÖ Select Server:', serverIndex);
    
    // OLD DATA ·Ä°·ÄÄ·ÄØ·Äî·Ä∫·Äñ·Äº·Äê·Ä∫
    resetRankData();
    
    currentServerIndex = serverIndex;
    currentServerName.textContent = `Server ${serverIndex + 1}`;
    
    serverSelection.style.display = 'none';
    rankView.style.display = 'block';
    
    // LOADING ·Äï·Äº·Äï·Äº·ÄÆ·Ä∏ ·Ä°·Äû·ÄÖ·Ä∫ DATA ·Äö·Ä∞
    startOneByOneFetching();
}

function switchRankTab(type) {
    console.log('‚úÖ Switch Rank Tab:', type);
    
    // OLD DATA ·Ä°·ÄÄ·ÄØ·Äî·Ä∫·Äñ·Äº·Äê·Ä∫
    resetRankData();
    
    currentRankType = type;
    
    // Update active tab
    rankTabs.forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.type === type) {
            tab.classList.add('active');
        }
    });
    
    // LOADING ·Äï·Äº·Äï·Äº·ÄÆ·Ä∏ ·Ä°·Äû·ÄÖ·Ä∫ DATA ·Äö·Ä∞
    startOneByOneFetching();
}

function resetRankData() {
    console.log('üóëÔ∏è Resetting Rank Data...');
    
    // Hide list container
    if (rankListContainer) {
        rankListContainer.style.display = 'none';
    }
    
    // Clear list - OLD DATA ·Ä°·ÄÄ·ÄØ·Äî·Ä∫·Äñ·Äº·Äê·Ä∫
    if (rankList) {
        rankList.innerHTML = '';
    }
    
    // Show loading
    if (rankLoading) {
        rankLoading.style.display = 'block';
    }
    
    // Reset fetching flag
    isFetching = false;
}

// ·Äê·ÄÖ·Ä∫·Äö·Ä±·Ä¨·ÄÄ·Ä∫·ÄÖ·ÄÆ Data ·Äö·Ä∞
async function startOneByOneFetching() {
    if (isFetching) return;
    isFetching = true;
    
    console.log('üîÑ Starting One-by-One Fetching...');
    
    try {
        // First get total user count
        const totalUsers = await getTotalUserCount();
        console.log(`üë• Total users in Server ${currentServerIndex + 1}: ${totalUsers}`);
        
        if (totalUsers === 0) {
            showNoDataMessage();
            isFetching = false;
            return;
        }
        
        // Fetch users one by one
        for (let i = 0; i < totalUsers; i++) {
            // Check if we should stop
            if (!isFetching) {
                console.log('‚èπÔ∏è Fetching stopped');
                break;
            }
            
            // Fetch single user
            const user = await fetchSingleUser(i);
            
            if (user) {
                // ·Äê·ÄÖ·Ä∫·Äö·Ä±·Ä¨·ÄÄ·Ä∫·Äö·Ä∞·Äï·Äº·ÄÆ·Ä∏·Äê·Ä¨·Äî·Ä≤·Ä∑ ·Äê·ÄÖ·Ä∫·Äö·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ·Ä≠·ÄØ·Äê·Äî·Ä∫·Ä∏·Äï·Äº·Äû·Äï·Ä±·Ä∏
                displayUserImmediately(user, i + 1);
                
                // Small delay between users
                if (i < totalUsers - 1) {
                    await delay(50); // 50ms delay
                }
            }
        }
        
        // Finish loading
        if (isFetching) {
            finishLoading();
        }
        
    } catch (error) {
        console.error('‚ùå Fetch error:', error);
        showErrorMessage();
        isFetching = false;
    }
}

// Get total user count
async function getTotalUserCount() {
    try {
        const supabaseClient = getSupabaseClient(currentServerIndex);
        const { count, error } = await supabaseClient
            .from('users')
            .select('*', { count: 'exact', head: true });
        
        if (error) {
            console.error('Count error:', error);
            return 0;
        }
        
        return Math.min(count || 0, 100); // Max 100 users
    } catch (error) {
        console.error('Get count error:', error);
        return 0;
    }
}

// Fetch single user by position (·Äê·ÄÖ·Ä∫·Äö·Ä±·Ä¨·ÄÄ·Ä∫·ÄÖ·ÄÆ)
async function fetchSingleUser(position) {
    try {
        const supabaseClient = getSupabaseClient(currentServerIndex);
        const orderField = currentRankType === 'coins' ? 'coins' : 'tokens';
        
        const { data, error } = await supabaseClient
            .from('users')
            .select('user_id, user_name, profile_image, tokens, coins')
            .order(orderField, { ascending: false })
            .range(position, position)
            .limit(1);
        
        if (error) {
            console.error(`Fetch error for position ${position}:`, error);
            return null;
        }
        
        return data && data.length > 0 ? data[0] : null;
    } catch (error) {
        console.error(`Single user fetch error:`, error);
        return null;
    }
}

// ·Äê·ÄÖ·Ä∫·Äö·Ä±·Ä¨·ÄÄ·Ä∫·Äö·Ä∞·Äï·Äº·ÄÆ·Ä∏·Äê·Ä¨·Äî·Ä≤·Ä∑ ·Äê·ÄÖ·Ä∫·Äö·Ä±·Ä¨·ÄÄ·Ä∫·ÄÄ·Ä≠·ÄØ·Äê·Äî·Ä∫·Ä∏·Äï·Äº·Äû·Äï·Ä±·Ä∏
function displayUserImmediately(user, position) {
    if (!rankList) return;
    
    const rankItem = document.createElement('div');
    rankItem.className = 'rank-item';
    
    // Add classes for top 3
    if (position === 1) rankItem.classList.add('top-1');
    else if (position === 2) rankItem.classList.add('top-2');
    else if (position === 3) rankItem.classList.add('top-3');
    
    // Check if current user
    if (user.user_id === currentUserData.userID) {
        rankItem.classList.add('current-user');
    }
    
    // Get score and icon based on rank type
    const score = currentRankType === 'coins' ? (user.coins || 0) : (user.tokens || 0);
    const iconSrc = currentRankType === 'coins' ? COIN_ICON : TOKEN_ICON;
    
    // Profile image or emoji
    let profileContent = '';
    if (user.profile_image) {
        profileContent = `<img src="${user.profile_image}" alt="Profile">`;
    } else {
        profileContent = '<div class="rank-emoji">üë§</div>';
    }
    
    rankItem.innerHTML = `
        <div class="rank-position">#${position}</div>
        <div class="rank-profile">${profileContent}</div>
        <div class="rank-info">
            <div class="rank-name">${user.user_name || 'Unknown'}</div>
            <div class="rank-score-display">
                <img src="${iconSrc}" class="score-icon">
                <span class="score-amount">${score.toLocaleString()}</span>
            </div>
        </div>
    `;
    
    // ·Äê·ÄÖ·Ä∫·Äö·Ä±·Ä¨·ÄÄ·Ä∫·Äö·Ä∞·Äï·Äº·ÄÆ·Ä∏·Äê·Ä¨·Äî·Ä≤·Ä∑ ·Äê·Äî·Ä∫·Ä∏·Äï·Äº·Äû·Äï·Ä±·Ä∏
    rankList.appendChild(rankItem);
    
    // Show list container when first item is added
    if (position === 1 && rankListContainer) {
        rankListContainer.style.display = 'block';
        if (rankLoading) {
            rankLoading.style.display = 'none';
        }
    }
    
    console.log(`‚úÖ Displayed user #${position}: ${user.user_name || 'Unknown'}`);
}

// Finish loading
function finishLoading() {
    if (rankLoading) {
        rankLoading.style.display = 'none';
    }
    if (rankListContainer && rankList.children.length > 0) {
        rankListContainer.style.display = 'block';
    }
    isFetching = false;
    console.log('‚úÖ Fetching completed');
}

// Show no data message
function showNoDataMessage() {
    if (rankLoading) {
        rankLoading.style.display = 'none';
    }
    if (rankList) {
        rankList.innerHTML = '<div style="text-align:center;color:white;padding:40px;font-size:16px;">No users found in this server</div>';
        rankListContainer.style.display = 'block';
    }
}

// Show error message
function showErrorMessage() {
    if (rankLoading) {
        rankLoading.style.display = 'none';
    }
    if (rankList) {
        rankList.innerHTML = '<div style="text-align:center;color:#ff6b6b;padding:40px;font-size:16px;">Error loading rank data</div>';
        rankListContainer.style.display = 'block';
    }
}

// Helper function for delay
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeRankSystem, 100);
});

</script>
</body>
</html>
